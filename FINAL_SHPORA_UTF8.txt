

// === FILE: \app\src\androidTest\java\com\aiden3630\chempionat\ExampleInstrumentedTest.kt ===

package com.aiden3630.chempionat

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.aiden3630.chempionat", appContext.packageName)
    }
}


// === FILE: \app\src\main\java\com\aiden3630\chempionat\App.kt ===

package com.aiden3630.chempionat

import android.app.Application
import dagger.hilt.android.HiltAndroidApp

@HiltAndroidApp
class App : Application()


// === FILE: \app\src\main\java\com\aiden3630\chempionat\MainActivity.kt ===

package com.aiden3630.chempionat

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import com.aiden3630.presentation.Route
import com.aiden3630.presentation.main.CreateProjectScreen
import com.aiden3630.presentation.auth.SignInScreen
import com.aiden3630.presentation.splash.SplashScreen
import com.aiden3630.presentation.auth.CreatePasswordScreen
import com.aiden3630.presentation.auth.CreatePinScreen
import com.aiden3630.presentation.auth.SignInPinScreen
import com.aiden3630.presentation.auth.SignUpScreen
import com.aiden3630.presentation.main.CartScreen
import com.aiden3630.presentation.main.MainScreen
import com.aiden3630.presentation.main.ProjectsScreen
import dagger.hilt.android.AndroidEntryPoint
import androidx.navigation.NavType
import androidx.navigation.navArgument
import android.Manifest
import android.os.Build
import androidx.activity.result.contract.ActivityResultContracts


@AndroidEntryPoint
class MainActivity : ComponentActivity() {
    private val requestPermissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestPermission()
    ) { isGranted: Boolean ->

    }
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
            requestPermissionLauncher.launch(Manifest.permission.POST_NOTIFICATIONS)
        }

        enableEdgeToEdge()
        setContent {
            val navController = rememberNavController()

            NavHost(
                navController = navController,
                startDestination = Route.SPLASH
            ) {

                composable(Route.SPLASH) {
                    SplashScreen(navController = navController)
                }

                composable(Route.SIGN_IN) {
                    SignInScreen(
                        onSignInClick = {
                            navController.navigate(Route.HOME) {
                                popUpTo(Route.SIGN_IN) { inclusive = true }
                            }
                        },
                        onSignUpClick = {
                            navController.navigate(Route.SIGN_UP)
                        }
                    )
                }

                composable(Route.SIGN_UP) {
                    SignUpScreen(
                        onNextClick = {
                            navController.navigate(Route.CREATE_PASSWORD)
                        },
                        onBackClick = {
                            navController.popBackStack()
                        }
                    )
                }

                composable(Route.CREATE_PASSWORD) {
                    CreatePasswordScreen(
                        onSaveClick = {
                            navController.navigate(Route.CREATE_PIN)
                        }
                    )
                }

                composable(Route.CREATE_PIN) {
                    CreatePinScreen(
                        onPinCreated = {
                            navController.navigate(Route.HOME) {
                                // Очищаем всё до входа, чтобы нельзя было вернуться назад
                                popUpTo(Route.SIGN_IN) { inclusive = true }
                            }
                        }
                    )
                }
                composable(Route.SIGN_IN_PIN) {
                    SignInPinScreen(
                        onAuthSuccess = {
                            // Пин верный = Пускаем в приложение
                            navController.navigate(Route.HOME) {
                                popUpTo(Route.SIGN_IN_PIN) { inclusive = true }
                            }
                        }
                    )
                }

                composable(Route.HOME) {
                    MainScreen(
                        onNavigateToCart = {
                            navController.navigate(Route.CART)
                        },
                        onNavigateToCreateProject = {
                            navController.navigate(Route.CREATE_PROJECT)
                        },
                        // Логика выхода
                        onLogout = {
                            navController.navigate(Route.SIGN_IN) {
                                // Удаляем всё из стека, чтобы нельзя было вернуться назад
                                popUpTo(0) { inclusive = true }
                            }
                        },
                        onNavigateToProjectDetails = { projectId ->
                            navController.navigate("${Route.PROJECT_DETAILS}/$projectId")
                        }
                    )

                }
                composable(Route.CART) {
                    com.aiden3630.presentation.main.CartScreen(
                        onBackClick = { navController.popBackStack() },
                        // Если заказ оформлен = идем на ГЛАВНУЮ
                        onGoHome = {
                            navController.navigate(Route.HOME) {
                                // Очищаем стек, чтобы по кнопке "Назад" не вернуться в корзину
                                popUpTo(Route.HOME) { inclusive = true }
                            }
                        }
                    )
                }
                composable(Route.PROJECTS_TAB) {
                    ProjectsScreen(
                        onAddProjectClick = {
                            navController.navigate(Route.CREATE_PROJECT)
                        }
                    )
                }

                // Экран Создания Проекта
                composable(Route.CREATE_PROJECT) {
                    CreateProjectScreen(
                        onBackClick = {
                            navController.popBackStack()
                        }
                    )
                }
                composable(
                    route = Route.PROJECT_DETAILS,
                    arguments = listOf(androidx.navigation.navArgument("projectId") {
                        type = androidx.navigation.NavType.StringType
                    })
                ) { backStackEntry ->
                    val projectId = backStackEntry.arguments?.getString("projectId") ?: ""
                    com.aiden3630.presentation.main.ProjectDetailsScreen(
                        projectId = projectId,
                        onBackClick = { navController.popBackStack() }
                    )
                }
                composable(
                    route = "${Route.PROJECT_DETAILS}/{projectId}",
                    arguments = listOf(navArgument("projectId") { type = NavType.StringType })
                ) { backStackEntry ->
                    // Достаем ID из аргументов
                    val projectId = backStackEntry.arguments?.getString("projectId") ?: ""

                    com.aiden3630.presentation.main.ProjectDetailsScreen(
                        projectId = projectId,
                        onBackClick = { navController.popBackStack() }
                    )
                }

            }
        }
    }
}


// === FILE: \app\src\test\java\com\aiden3630\chempionat\ExampleUnitTest.kt ===

package com.aiden3630.chempionat

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}


// === FILE: \app\build.gradle.kts ===

plugins {
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.compose.compiler) // Включаем плагин Compose
    alias(libs.plugins.hilt.android) // Hilt (пригодится позже)
    alias(libs.plugins.google.devtools.ksp)
}

android {
    namespace = "com.aiden3630.chempionat"
    compileSdk = 35

    defaultConfig {
        applicationId = "com.aiden3630.chempionat"
        minSdk = 33 // По заданию
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            isMinifyEnabled = false
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = "11"
    }
    // Включаем Compose
    buildFeatures {
        compose = true
    }
}

dependencies {
    implementation(project(":presentation"))
    implementation(project(":data"))
    implementation(project(":domain"))

    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)
    implementation(libs.androidx.activity.compose)
    implementation(platform(libs.androidx.compose.bom))
    implementation(libs.androidx.ui)
    implementation(libs.androidx.ui.graphics)
    implementation(libs.androidx.ui.tooling.preview)
    implementation(libs.androidx.material3)
    implementation(libs.androidx.navigation.compose)


    // Hilt
    implementation(libs.hilt.android)
    ksp(libs.hilt.compiler)

    debugImplementation(libs.androidx.ui.tooling)
}


// === FILE: \data\src\androidTest\java\com\aiden3630\data\ExampleInstrumentedTest.kt ===

package com.aiden3630.data

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.aiden3630.data.test", appContext.packageName)
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\di\AuthModule.kt ===

package com.aiden3630.data.di

import android.content.Context
import com.aiden3630.data.manager.JsonDbManager
import com.aiden3630.data.manager.TokenManager
import com.aiden3630.data.network.AuthApi
import com.aiden3630.data.repository.AuthRepositoryImpl
import com.aiden3630.data.repository.ProjectRepositoryImpl
import com.aiden3630.data.repository.ShopRepositoryImpl
import com.aiden3630.domain.repository.AuthRepository
import com.aiden3630.domain.repository.ProjectRepository
import com.aiden3630.domain.repository.ShopRepository
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.android.qualifiers.ApplicationContext
import dagger.hilt.components.SingletonComponent
import retrofit2.Retrofit
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object AuthModule {

    @Provides
    @Singleton
    fun provideAuthApi(retrofit: Retrofit): AuthApi {
        return retrofit.create(AuthApi::class.java)
    }

    @Provides
    @Singleton
    fun provideAuthRepository(
        api: AuthApi,
        tokenManager: TokenManager,
        jsonDbManager: JsonDbManager
    ): AuthRepository {
        return AuthRepositoryImpl(api, tokenManager, jsonDbManager)
    }

    @Provides
    @Singleton
    fun provideShopRepository(
        @ApplicationContext context: Context
    ): ShopRepository {
        return ShopRepositoryImpl(context)
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\di\NetworkModule.kt ===

package com.aiden3630.data.di

import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import kotlinx.serialization.json.Json
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.OkHttpClient
import okhttp3.logging.HttpLoggingInterceptor
import retrofit2.Retrofit
import retrofit2.converter.kotlinx.serialization.asConverterFactory
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object NetworkModule {

    // Ссылка на сервер (пока заглушка, потом поменяем на реальный IP)
    private const val BASE_URL = "https://api.matule.ru/api/"

    @Provides
    @Singleton
    fun provideJson(): Json {
        return Json {
            ignoreUnknownKeys = true // Игнорировать лишние поля в ответе сервера
            isLenient = true
        }
    }

    @Provides
    @Singleton
    fun provideOkHttpClient(): OkHttpClient {
        return OkHttpClient.Builder()
            .addInterceptor(
                HttpLoggingInterceptor().apply {
                    level = HttpLoggingInterceptor.Level.BODY // Логировать всё (для отладки)
                }
            )
            .build()
    }

    @Provides
    @Singleton
    fun provideRetrofit(okHttpClient: OkHttpClient, json: Json): Retrofit {
        return Retrofit.Builder()
            .baseUrl(BASE_URL)
            .client(okHttpClient)
            .addConverterFactory(json.asConverterFactory("application/json".toMediaType()))
            .build()
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\di\ProjectModule.kt ===

package com.aiden3630.data.di

import com.aiden3630.data.manager.TokenManager
import com.aiden3630.data.repository.ProjectRepositoryImpl
import com.aiden3630.domain.repository.ProjectRepository
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

@Module
@InstallIn(SingletonComponent::class)
object ProjectModule {
    @Provides
    @Singleton
    fun provideProjectRepository(tokenManager: TokenManager): ProjectRepository {
        return ProjectRepositoryImpl(tokenManager)
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\manager\CartManager.kt ===

package com.aiden3630.data.manager

import com.aiden3630.domain.model.CartItemModel
import com.aiden3630.domain.model.Product
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.map
import javax.inject.Inject
import javax.inject.Singleton

@Singleton
class CartManager @Inject constructor() {

    // Список товаров
    private val _cartItems = MutableStateFlow<List<CartItemModel>>(emptyList())
    val cartItems = _cartItems.asStateFlow()

    // Сумма
    val totalPrice = _cartItems.map { list ->
        list.sumOf { it.product.price * it.quantity }
    }

    // Добавить товар (или увеличить количество)
    fun addToCart(product: Product) {
        val currentList = _cartItems.value

        // Проверяем, есть ли товар
        val existingItem = currentList.find { it.product.id == product.id }

        val newList = if (existingItem != null) {
            // Если товар есть = Создаем НОВЫЙ список, где у нужного товара обновлено количество
            currentList.map { item ->
                if (item.product.id == product.id) {
                    item.copy(quantity = item.quantity + 1)
                } else {
                    item
                }
            }
        } else {
            // Если товара нет = Добавляем новый в конец
            currentList + CartItemModel(product, 1)
        }

        _cartItems.value = newList
    }

    // Уменьшить количество
    fun decreaseQuantity(product: Product) {
        val currentList = _cartItems.value
        val item = currentList.find { it.product.id == product.id } ?: return

        if (item.quantity > 1) {
            // Уменьшаем копированием
            val newList = currentList.map { cartItem ->
                if (cartItem.product.id == product.id) {
                    cartItem.copy(quantity = cartItem.quantity - 1)
                } else {
                    cartItem
                }
            }
            _cartItems.value = newList
        } else {
            // Если 1 шт = удаляем
            removeFromCart(product)
        }
    }

    // Удалить товар
    fun removeFromCart(product: Product) {
        val currentList = _cartItems.value
        // filter создает новый список без удаленного элемента
        val newList = currentList.filter { it.product.id != product.id }
        _cartItems.value = newList
    }

    // Проверка наличия
    fun isInCart(productId: Int): Boolean {
        return _cartItems.value.any { it.product.id == productId }
    }
    fun clearCart() {
        _cartItems.value = emptyList()
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\manager\JsonDbManager.kt ===

package com.aiden3630.data.manager

import android.content.Context
import com.aiden3630.data.model.UserDto
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.sync.Mutex
import kotlinx.coroutines.sync.withLock
import kotlinx.coroutines.withContext
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import java.io.File
import javax.inject.Inject
import javax.inject.Singleton

@Singleton
class JsonDbManager @Inject constructor(
    @ApplicationContext private val context: Context
) {
    // Имя нашего файла
    private val fileName = "matule_users_db.json"

    // JSON конфигурация
    private val json = Json {
        ignoreUnknownKeys = true
        prettyPrint = true
        encodeDefaults = true
    }

    // Мьютекс, чтобы не было ошибок, если два потока пишут одновременно
    private val mutex = Mutex()

    // Получить файл (или создать, если нет)
    private fun getFile(): File {
        val file = File(context.filesDir, fileName)
        if (!file.exists()) {
            file.createNewFile()
            file.writeText("[]") // Записываем пустой массив
        }
        return file
    }

    // Читаем пользователей
    suspend fun getAllUsers(): List<UserDto> = withContext(Dispatchers.IO) {
        mutex.withLock {
            try {
                val file = getFile()
                val content = file.readText()
                if (content.isBlank()) return@withLock emptyList()

                json.decodeFromString<List<UserDto>>(content)
            } catch (e: Exception) {
                e.printStackTrace()
                emptyList()
            }
        }
    }

    // Сохраняем список
    suspend fun saveAllUsers(users: List<UserDto>) = withContext(Dispatchers.IO) {
        mutex.withLock {
            try {
                val file = getFile()
                val jsonString = json.encodeToString(users)
                file.writeText(jsonString)
            } catch (e: Exception) {
                e.printStackTrace()
            }
        }
    }

    // Добавить одного
    suspend fun addUser(user: UserDto) {
        val currentList = getAllUsers().toMutableList()
        currentList.add(user)
        saveAllUsers(currentList)
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\manager\TokenManager.kt ===

package com.aiden3630.data.manager

import android.content.Context
import androidx.datastore.preferences.core.edit
import androidx.datastore.preferences.core.stringPreferencesKey
import androidx.datastore.preferences.preferencesDataStore
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.map
import javax.inject.Inject
import javax.inject.Singleton
import androidx.datastore.preferences.core.booleanPreferencesKey

// Создаем хранилище
private val Context.dataStore by preferencesDataStore("auth_prefs")

@Singleton
class TokenManager @Inject constructor(
    @ApplicationContext private val context: Context
) {

    companion object {
        private val TOKEN_KEY = stringPreferencesKey("jwt_token")
        private val EMAIL_KEY = stringPreferencesKey("user_email")
        private val PASSWORD_KEY = stringPreferencesKey("user_password")

        // Данные профиля
        private val NAME_KEY = stringPreferencesKey("user_name")
        private val SURNAME_KEY = stringPreferencesKey("user_surname")
        private val AVATAR_KEY = stringPreferencesKey("user_avatar")

        // База всех пользователей (JSON)
        private val ALL_USERS_DB_KEY = stringPreferencesKey("all_users_db_json")
        private val PROJECTS_DB_KEY = stringPreferencesKey("projects_db_json")

        private val NOTIFICATIONS_KEY = booleanPreferencesKey("notifications_enabled")

        private val USER_PIN_KEY = stringPreferencesKey("user_pin_code")
    }

    // База данных пользователей (JSON)
    fun getUsersDb(): Flow<String> = context.dataStore.data.map { it[ALL_USERS_DB_KEY] ?: "[]" }

    suspend fun saveUsersDb(json: String) {
        context.dataStore.edit { it[ALL_USERS_DB_KEY] = json }
    }
    fun getProjects(): Flow<String> = context.dataStore.data.map { it[PROJECTS_DB_KEY] ?: "[]" }

    // Сохранить список проектов
    suspend fun saveProjects(json: String) {
        context.dataStore.edit { it[PROJECTS_DB_KEY] = json }
    }

    // Токен
    fun getToken(): Flow<String?> = context.dataStore.data.map { it[TOKEN_KEY] }
    suspend fun saveToken(token: String) = context.dataStore.edit { it[TOKEN_KEY] = token }

    // Данные текущего пользователя
    fun getEmail(): Flow<String> = context.dataStore.data.map { it[EMAIL_KEY] ?: "" }
    fun getPassword(): Flow<String> = context.dataStore.data.map { it[PASSWORD_KEY] ?: "" }
    fun getName(): Flow<String> = context.dataStore.data.map { it[NAME_KEY] ?: "Пользователь" }
    fun getSurname(): Flow<String> = context.dataStore.data.map { it[SURNAME_KEY] ?: "" }
    fun getNotificationsEnabled(): Flow<Boolean> = context.dataStore.data
        .map { it[NOTIFICATIONS_KEY] ?: true }

    suspend fun saveNotificationsEnabled(enabled: Boolean) {
        context.dataStore.edit { it[NOTIFICATIONS_KEY] = enabled }
    }

    // Сохранение почты и пароля
    suspend fun saveUserData(email: String, pass: String) {
        context.dataStore.edit { prefs ->
            prefs[EMAIL_KEY] = email
            prefs[PASSWORD_KEY] = pass
        }
    }

    // Сохранение профиля (после входа)
    suspend fun saveUserInfo(email: String, name: String, surname: String) {
        context.dataStore.edit { prefs ->
            prefs[EMAIL_KEY] = email
            prefs[NAME_KEY] = name
            prefs[SURNAME_KEY] = surname
        }
    }

    suspend fun savePin(pin: String) {
        context.dataStore.edit { it[USER_PIN_KEY] = pin }
    }

    fun getPin(): Flow<String?> = context.dataStore.data.map { it[USER_PIN_KEY] }

    // Очистка (Выход)
    suspend fun clearSession() {
        context.dataStore.edit { prefs ->
            prefs.remove(TOKEN_KEY)
            // prefs.remove(EMAIL_KEY)
            // prefs.remove(PASSWORD_KEY)
            prefs.remove(NAME_KEY)
            prefs.remove(SURNAME_KEY)
            prefs.remove(AVATAR_KEY)
        }
    }

}


// === FILE: \data\src\main\java\com\aiden3630\data\model\AuthModels.kt ===

package com.aiden3630.data.model

import kotlinx.serialization.SerialName
import kotlinx.serialization.Serializable

@Serializable
data class SignInRequest(
    @SerialName("identity") val identity: String,
    @SerialName("password") val password: String
)

@Serializable
data class SignInResponse(
    @SerialName("token") val token: String,
    @SerialName("record") val user: UserDto
)

@Serializable
data class SignUpRequest(
    @SerialName("email") val email: String,
    @SerialName("password") val password: String,
    @SerialName("passwordConfirm") val passwordConfirm: String,
    @SerialName("firstname") val name: String,
    @SerialName("lastname") val surname: String
)

@Serializable
data class UserDto(
    @SerialName("id") val id: String,
    @SerialName("email") val email: String? = null,
    @SerialName("password") val password: String? = null,
    @SerialName("firstname") val name: String,
    @SerialName("lastname") val surname: String,
    @SerialName("avatar") val avatar: String? = null
)


// === FILE: \data\src\main\java\com\aiden3630\data\network\AuthApi.kt ===

package com.aiden3630.data.network

import com.aiden3630.data.model.SignInRequest
import com.aiden3630.data.model.SignInResponse
import com.aiden3630.data.model.SignUpRequest
import com.aiden3630.data.model.UserDto
import retrofit2.http.Body
import retrofit2.http.POST

interface AuthApi {


    @POST("collections/users/auth-with-password")
    suspend fun signIn(@Body request: SignInRequest): SignInResponse

    @POST("collections/users/records")
    suspend fun signUp(@Body request: SignUpRequest): UserDto
}


// === FILE: \data\src\main\java\com\aiden3630\data\repository\AuthRepositoryImpl.kt ===

package com.aiden3630.data.repository

import android.util.Log
import com.aiden3630.data.manager.TokenManager
import com.aiden3630.data.manager.JsonDbManager
import com.aiden3630.data.model.UserDto
import com.aiden3630.data.network.AuthApi
import com.aiden3630.domain.repository.AuthRepository
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.first
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import java.util.UUID
import javax.inject.Inject

class AuthRepositoryImpl @Inject constructor(
    private val api: AuthApi,
    private val tokenManager: TokenManager,
    private val jsonDbManager: JsonDbManager
) : AuthRepository {

    private val jsonParser = Json {
        ignoreUnknownKeys = true
        coerceInputValues = true
    }

    override suspend fun signIn(email: String, password: String) {
        delay(1000) // Имитация сети

        // 1. Читаем реальный файл
        val usersList = jsonDbManager.getAllUsers()

        // 2. Ищем пользователя по Email И Пароли
        val foundUser = usersList.find {
            it.email.equals(email, ignoreCase = true) && it.password == password
        }

        if (foundUser != null) {
            val fakeToken = "token_${foundUser.id}"

            // Сохраняем сессию
            tokenManager.saveToken(fakeToken)
            tokenManager.saveUserInfo(
                email = foundUser.email ?: email,
                name = foundUser.name,
                surname = foundUser.surname
            )
            Log.d("AuthRepo", "ВХОД УСПЕШЕН из файла: ${foundUser.name}")
        } else {
            // Проверяем, может email есть, но пароль не тот?
            val emailExists = usersList.any { it.email.equals(email, ignoreCase = true) }
            if (emailExists) {
                throw Exception("Неверный пароль")
            } else {
                throw Exception("Пользователь не найден")
            }
        }
    }

    override suspend fun signUp(email: String, password: String, name: String, surname: String) {
        delay(1000)

        // 1. Читаем файл для проверки дубликатов
        val currentUsers = jsonDbManager.getAllUsers()

        if (currentUsers.any { it.email.equals(email, ignoreCase = true) }) {
            throw Exception("Почта уже занята")
        }

        // 2. Создаем объект
        val newUser = UserDto(
            id = UUID.randomUUID().toString(),
            email = email,
            password = password,
            name = name,
            surname = surname,
            avatar = null
        )

        // 3. Пишем в файл
        jsonDbManager.addUser(newUser)

        // 4. Автоматический вход
        tokenManager.saveToken("token_${newUser.id}")
        tokenManager.saveUserInfo(email, name, surname)

        Log.d("AuthRepo", "Юзер записан в файл users.json")
    }
}



// === FILE: \data\src\main\java\com\aiden3630\data\repository\ProjectRepositoryImpl.kt ===

package com.aiden3630.data.repository

import com.aiden3630.data.manager.TokenManager
import com.aiden3630.domain.model.UserProject
import com.aiden3630.domain.repository.ProjectRepository
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.flow.map
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import java.util.UUID
import javax.inject.Inject

class ProjectRepositoryImpl @Inject constructor(
    private val tokenManager: TokenManager
) : ProjectRepository {

    private val json = Json { ignoreUnknownKeys = true }

    override suspend fun createProject(name: String, type: String, dateStart: String, imageUri: String?) {
        // 1. Читаем текущий список
        val projectsJson = tokenManager.getProjects().first()
        val currentList = try {
            json.decodeFromString<MutableList<UserProject>>(projectsJson)
        } catch (e: Exception) {
            mutableListOf()
        }

        // 2. Создаем новый проект
        val newProject = UserProject(
            id = UUID.randomUUID().toString(),
            name = name,
            type = type,
            dateStart = dateStart,
            category = "Своё",
            imageUri = imageUri
        )

        // 3. Добавляем и сохраняем
        currentList.add(0, newProject) // Добавляем в начало списка
        val newJson = json.encodeToString(currentList)

        tokenManager.saveProjects(newJson)
    }

    // Метод для получения списка
    override fun getAllProjects(): Flow<List<UserProject>> {
        return tokenManager.getProjects().map { jsonString ->
            try {
                json.decodeFromString<List<UserProject>>(jsonString)
            } catch (e: Exception) {
                emptyList()
            }
        }
    }
    override suspend fun getProjectById(id: String): UserProject? {
        val projectsJson = tokenManager.getProjects().first()
        val list = try {
            json.decodeFromString<List<UserProject>>(projectsJson)
        } catch (e: Exception) { emptyList() }

        return list.find { it.id == id }
    }
}


// === FILE: \data\src\main\java\com\aiden3630\data\repository\ShopRepositoryImpl.kt ===

package com.aiden3630.data.repository

import android.content.Context
import com.aiden3630.domain.model.Product
import com.aiden3630.domain.repository.ShopRepository
import dagger.hilt.android.qualifiers.ApplicationContext
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import kotlinx.serialization.encodeToString
import kotlinx.serialization.json.Json
import java.io.File
import javax.inject.Inject

class ShopRepositoryImpl @Inject constructor(
    @ApplicationContext private val context: Context // Нам нужен контекст
) : ShopRepository {

    private val jsonParser = Json {
        ignoreUnknownKeys = true
        prettyPrint = true
    }

    private val fileName = "shop_products.json"

    // Дефолтный список, который запишется при первом запуске
    private fun getDefaultProducts(): List<Product> {
        return listOf(
            Product(
                id = 1,
                title = "Рубашка Воскресенье",
                price = 300,
                category = "Мужчинам",
                description = "Мой выбор для этих шапок – кардные составы, которые раскрываются деликатным пушком. Кашемиры, мериносы, смесовки с ними отлично подойдут на шапку.\n" +
                        "Кардные составы берите в большое количество сложений, вязать будем резинку 1х1, плотненько.\n" +
                        "Примерный расход на шапку с подгибом 70-90г."
            ),
            Product(
                id = 2,
                title = "Шорты Вторник",
                price = 400,
                category = "Мужчинам",
                description = "Легкие и удобные шорты для дома и отдыха. \n" +
                        "Рекомендуемая пряжа: хлопок с акрилом (50/50) или чистый хлопок мерсеризованный.\n" +
                        "Спицы: №3 для резинки, №4 для основного полотна.\n" +
                        "Плотность вязания: 20 петель х 28 рядов = 10х10 см.\n" +
                        "Особенности: вяжутся снизу вверх, без швов, пояс на кулиске."
            ),
            Product(
                id = 3,
                title = "Платье Среда",
                price = 800,
                category = "Женщинам",
                description = "Элегантное платье силуэта трапеция.\n" +
                        "Идеально подходит для летних прогулок. Используйте натуральный лен или шелк.\n" +
                        "Вам понадобится:\n" +
                        "- Ткань: 2.5 метра при ширине 140 см.\n" +
                        "- Потайная молния 50 см.\n" +
                        "- Нитки в тон.\n" +
                        "Сложность: Средняя (требует навыков втачивания молнии)."
            ),
            Product(
                id = 4,
                title = "Футболка Четверг",
                price = 450,
                category = "Детям",
                description = "Базовая футболка оверсайз для ребенка.\n" +
                        "Материал: Кулирная гладь (100% хлопок) или футер 2-х нитка.\n" +
                        "Расход ткани: 0.6 - 0.8 метра в зависимости от роста.\n" +
                        "В выкройке учтены припуски на швы 0.7 см.\n" +
                        "Отлично сочетается с джинсами или спортивными штанами."
            ),
            Product(
                id = 5,
                title = "Кепка Пятница",
                price = 150,
                category = "Аксессуары",
                description = "Стильный аксессуар для завершения образа.\n" +
                        "Вязание крючком №3.5.\n" +
                        "Пряжа: Рафия (натуральное волокно из листьев пальмы).\n" +
                        "Расход: 1.5 мотка (около 150 метров).\n" +
                        "Кепка держит форму, не боится влаги и отлично защищает от солнца."
            )
        )
    }

    override fun getProducts(): Flow<List<Product>> = flow {
        try {
            val file = File(context.filesDir, fileName)

            // Если файла нет - создаем
            if (!file.exists()) {
                file.createNewFile()
                val defaultData = getDefaultProducts()
                val jsonString = jsonParser.encodeToString(defaultData)
                file.writeText(jsonString)
            }

            // Читаем из файла
            val content = file.readText()
            val products = jsonParser.decodeFromString<List<Product>>(content)
            emit(products)

        } catch (e: Exception) {
            e.printStackTrace()
            emit(emptyList())
        }
    }
}


// === FILE: \data\src\test\java\com\aiden3630\data\AuthRepositoryTest.kt ===

package com.aiden3630.data

import com.aiden3630.data.manager.TokenManager
import com.aiden3630.data.network.AuthApi
import com.aiden3630.data.repository.AuthRepositoryImpl
import io.mockk.coEvery
import io.mockk.coVerify
import io.mockk.mockk
import kotlinx.coroutines.flow.flowOf
import kotlinx.coroutines.test.runTest
import org.junit.Test

class AuthRepositoryTest {

    // Создаем фейковые классы (пустышки)
    private val api = mockk<AuthApi>(relaxed = true)
    private val tokenManager = mockk<TokenManager>(relaxed = true)

    // Создаем реальный репозиторий, но даем ему фейки
    private val repository = AuthRepositoryImpl(api, tokenManager)

    @Test
    fun `signIn saves token and user info`() = runTest {
        // GIVEN (Дано)
        val email = "test@mail.ru"
        val password = "pass"

        // Обманываем репозиторий: говорим, что в базе есть такой юзер
        coEvery { tokenManager.getUsersDb() } returns flowOf(
            """[{"id":"1","email":"test@mail.ru","firstname":"Test","lastname":"User"}]"""
        )

        // WHEN (Когда)
        repository.signIn(email, password)

        // THEN (Тогда проверяем)
        // Убеждаемся, что репозиторий вызвал метод сохранения
        coVerify { tokenManager.saveToken(any()) }
        coVerify { tokenManager.saveUserInfo(email, "Test", "User") }
    }
}


// === FILE: \data\build.gradle.kts ===

plugins {
    alias(libs.plugins.android.library)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.google.devtools.ksp) // Hilt
    alias(libs.plugins.jetbrains.kotlin.serialization) // JSON
}

android {
    namespace = "com.aiden3630.data"
    compileSdk = 35
    defaultConfig { minSdk = 33 }
    compileOptions { sourceCompatibility = JavaVersion.VERSION_11; targetCompatibility = JavaVersion.VERSION_11 }
    kotlinOptions { jvmTarget = "11" }
    testOptions {
        unitTests.isReturnDefaultValues = true
    }
}

dependencies {
    implementation(project(":domain")) // 👇 Зависит от Domain

    // Сеть
    implementation(libs.retrofit)
    implementation(libs.okhttp)
    implementation(libs.okhttp.logging)
    implementation(libs.retrofit.converter.kotlinx.serialization)
    implementation(libs.kotlinx.serialization.json)

    // DataStore
    implementation(libs.androidx.datastore.preferences)

    // Hilt
    implementation(libs.hilt.android)
    ksp(libs.hilt.compiler)
    testImplementation(libs.junit)
    testImplementation(libs.mockk)
    testImplementation(libs.kotlinx.coroutines.test)
}


// === FILE: \domain\src\androidTest\java\com\aiden3630\domain\ExampleInstrumentedTest.kt ===

package com.aiden3630.domain

import androidx.test.platform.app.InstrumentationRegistry
import androidx.test.ext.junit.runners.AndroidJUnit4

import org.junit.Test
import org.junit.runner.RunWith

import org.junit.Assert.*

/**
 * Instrumented test, which will execute on an Android device.
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
@RunWith(AndroidJUnit4::class)
class ExampleInstrumentedTest {
    @Test
    fun useAppContext() {
        // Context of the app under test.
        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
        assertEquals("com.aiden3630.domain.test", appContext.packageName)
    }
}


// === FILE: \domain\src\main\java\com\aiden3630\domain\model\Product.kt ===

package com.aiden3630.domain.model

import kotlinx.serialization.Serializable

@Serializable
data class Product(
    val id: Int,
    val title: String,
    val price: Int,
    val category: String,
    val description: String = ""
)
data class CartItemModel(
    val product: Product,
    var quantity: Int = 1
)


// === FILE: \domain\src\main\java\com\aiden3630\domain\model\UserProject.kt ===

package com.aiden3630.domain.model

import kotlinx.serialization.Serializable

@Serializable
data class UserProject(
    val id: String,
    val name: String,
    val type: String,
    val dateStart: String,
    val imageUri: String?,
    val category: String
)


// === FILE: \domain\src\main\java\com\aiden3630\domain\repository\AuthRepository.kt ===

package com.aiden3630.domain.repository

interface AuthRepository {
    suspend fun signIn(email: String, password: String)

    suspend fun signUp(email: String, password: String, name: String, surname: String)
}


// === FILE: \domain\src\main\java\com\aiden3630\domain\repository\ProjectRepository.kt ===

package com.aiden3630.domain.repository

import com.aiden3630.domain.model.UserProject
import kotlinx.coroutines.flow.Flow

interface ProjectRepository {
    suspend fun createProject(name: String, type: String, dateStart: String, imageUri: String?)
    fun getAllProjects(): Flow<List<UserProject>>
    suspend fun getProjectById(id: String): com.aiden3630.domain.model.UserProject?
}


// === FILE: \domain\src\main\java\com\aiden3630\domain\repository\ShopRepository.kt ===

package com.aiden3630.domain.repository

import com.aiden3630.domain.model.Product
import kotlinx.coroutines.flow.Flow

interface ShopRepository {
    fun getProducts(): Flow<List<Product>>
}


// === FILE: \domain\src\test\java\com\aiden3630\domain\ExampleUnitTest.kt ===

package com.aiden3630.domain

import org.junit.Test

import org.junit.Assert.*

/**
 * Example local unit test, which will execute on the development machine (host).
 *
 * See [testing documentation](http://d.android.com/tools/testing).
 */
class ExampleUnitTest {
    @Test
    fun addition_isCorrect() {
        assertEquals(4, 2 + 2)
    }
}


// === FILE: \domain\build.gradle.kts ===

plugins {
    alias(libs.plugins.android.library)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.jetbrains.kotlin.serialization)
}

android {
    namespace = "com.aiden3630.domain"
    compileSdk = 35
    defaultConfig { minSdk = 33 }
    compileOptions { sourceCompatibility = JavaVersion.VERSION_11; targetCompatibility = JavaVersion.VERSION_11 }
    kotlinOptions { jvmTarget = "11" }
}

dependencies {

    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.appcompat)
    implementation(libs.material)
    testImplementation(libs.junit)
    androidTestImplementation(libs.androidx.junit)
    androidTestImplementation(libs.androidx.espresso.core)
    implementation(libs.kotlinx.serialization.json)
}


// === FILE: \gradle\libs.versions.toml ===

[versions]
agp = "8.12.3"
kotlin = "2.0.21"
coreKtx = "1.15.0"
junit = "4.13.2"
junitVersion = "1.2.1"
espressoCore = "3.6.1"
lifecycleRuntimeKtx = "2.8.7"
activityCompose = "1.9.3"
composeBom = "2024.11.00"
appcompat = "1.7.0"
material = "1.12.0"
mockk = "1.13.8"
coroutinesTest = "1.7.3"

# Network (Модуль В)
retrofit = "2.11.0"
okhttp = "4.12.0"
kotlinxSerialization = "1.7.3"

# DI (Модуль А - Архитектура)
hilt = "2.51.1"
ksp = "2.0.21-1.0.27" # Плагин для обработки аннотаций (вместо kapt)

# Navigation (Модуль Б)
navigationCompose = "2.8.4"

# Image Loading (Кэширование картинок - Модуль Г)
coil = "2.7.0"

# Local Storage (Кэширование данных - Модуль Г)
room = "2.6.1"
datastore = "1.1.1"

[libraries]
androidx-core-ktx = { group = "androidx.core", name = "core-ktx", version.ref = "coreKtx" }
junit = { group = "junit", name = "junit", version.ref = "junit" }
androidx-junit = { group = "androidx.test.ext", name = "junit", version.ref = "junitVersion" }
androidx-espresso-core = { group = "androidx.test.espresso", name = "espresso-core", version.ref = "espressoCore" }
androidx-appcompat = { group = "androidx.appcompat", name = "appcompat", version.ref = "appcompat" }
material = { group = "com.google.android.material", name = "material", version.ref = "material" }

# --- Jetpack Compose (UI) ---
androidx-lifecycle-runtime-ktx = { group = "androidx.lifecycle", name = "lifecycle-runtime-ktx", version.ref = "lifecycleRuntimeKtx" }
androidx-activity-compose = { group = "androidx.activity", name = "activity-compose", version.ref = "activityCompose" }
androidx-compose-bom = { group = "androidx.compose", name = "compose-bom", version.ref = "composeBom" }
androidx-ui = { group = "androidx.compose.ui", name = "ui" }
androidx-ui-graphics = { group = "androidx.compose.ui", name = "ui-graphics" }
androidx-ui-tooling = { group = "androidx.compose.ui", name = "ui-tooling" }
androidx-ui-tooling-preview = { group = "androidx.compose.ui", name = "ui-tooling-preview" }
androidx-material3 = { group = "androidx.compose.material3", name = "material3" }
androidx-navigation-compose = { group = "androidx.navigation", name = "navigation-compose", version.ref = "navigationCompose" }

# --- Network (Retrofit + OkHttp) ---
retrofit = { group = "com.squareup.retrofit2", name = "retrofit", version.ref = "retrofit" }
retrofit-converter-kotlinx-serialization = { group = "com.squareup.retrofit2", name = "converter-kotlinx-serialization", version.ref = "retrofit" }
okhttp = { group = "com.squareup.okhttp3", name = "okhttp", version.ref = "okhttp" }
okhttp-logging = { group = "com.squareup.okhttp3", name = "logging-interceptor", version.ref = "okhttp" }
kotlinx-serialization-json = { group = "org.jetbrains.kotlinx", name = "kotlinx-serialization-json", version.ref = "kotlinxSerialization" }

# --- Dependency Injection (Hilt) ---
hilt-android = { group = "com.google.dagger", name = "hilt-android", version.ref = "hilt" }
hilt-compiler = { group = "com.google.dagger", name = "hilt-android-compiler", version.ref = "hilt" }
androidx-hilt-navigation-compose = { group = "androidx.hilt", name = "hilt-navigation-compose", version = "1.2.0" }

# --- Images (Coil) ---
coil-compose = { group = "io.coil-kt", name = "coil-compose", version.ref = "coil" }

# --- Local DB (Room) ---
androidx-room-runtime = { group = "androidx.room", name = "room-runtime", version.ref = "room" }
androidx-room-ktx = { group = "androidx.room", name = "room-ktx", version.ref = "room" }
androidx-room-compiler = { group = "androidx.room", name = "room-compiler", version.ref = "room" }
androidx-datastore-preferences = { group = "androidx.datastore", name = "datastore-preferences", version.ref = "datastore" }
# Unit Tests (Логика)
mockk = { group = "io.mockk", name = "mockk", version.ref = "mockk" }
kotlinx-coroutines-test = { group = "org.jetbrains.kotlinx", name = "kotlinx-coroutines-test", version.ref = "coroutinesTest" }

# UI Tests (Интерфейс)
androidx-ui-test-junit4 = { group = "androidx.compose.ui", name = "ui-test-junit4" }
androidx-ui-test-manifest = { group = "androidx.compose.ui", name = "ui-test-manifest" }

[plugins]
android-application = { id = "com.android.application", version.ref = "agp" }
kotlin-android = { id = "org.jetbrains.kotlin.android", version.ref = "kotlin" }
android-library = { id = "com.android.library", version.ref = "agp" }
# Новые плагины
jetbrains-kotlin-serialization = { id = "org.jetbrains.kotlin.plugin.serialization", version.ref = "kotlin" }
google-devtools-ksp = { id = "com.google.devtools.ksp", version.ref = "ksp" }
hilt-android = { id = "com.google.dagger.hilt.android", version.ref = "hilt" }
compose-compiler = { id = "org.jetbrains.kotlin.plugin.compose", version.ref = "kotlin" }



// === FILE: \presentation\src\androidTest\java\com\aiden3630\presentation\MatuleTextFieldTest.kt ===

package com.aiden3630.presentation

import androidx.compose.ui.test.assertIsDisplayed
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.compose.ui.test.onNodeWithText
import com.aiden3630.presentation.components.MatuleTextField
import org.junit.Rule
import org.junit.Test

class MatuleTextFieldTest {

    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun textField_showsError() {
        // Рисуем компонент на виртуальном экране
        composeTestRule.setContent {
            MatuleTextField(
                value = "",
                onValueChange = {},
                placeholder = "Email",
                isError = true, // Включаем ошибку
                errorMessage = "Ошибка ввода" // Текст ошибки
            )
        }

        // Ищем текст "Ошибка ввода" и проверяем, что он виден
        composeTestRule.onNodeWithText("Ошибка ввода").assertIsDisplayed()
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\CreatePasswordScreen.kt ===

package com.aiden3630.presentation.auth

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.components.MatuleButton
import com.aiden3630.presentation.components.MatuleTextField
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR
import androidx.hilt.navigation.compose.hiltViewModel
import android.widget.Toast
import androidx.compose.ui.platform.LocalContext

@Composable
fun CreatePasswordScreen(
    onSaveClick: () -> Unit = {},
    viewModel: CreatePasswordViewModel = hiltViewModel()
) {
    val context = LocalContext.current
    var password by remember { mutableStateOf("") }
    var confirmPassword by remember { mutableStateOf("") }
    LaunchedEffect(Unit) {
        viewModel.event.collect { event ->
            when (event) {
                is AuthEvent.Success -> {
                    Toast.makeText(context, "Пароль успешно создан!", Toast.LENGTH_SHORT).show()
                    onSaveClick() // Переход на следующий экран (ПИН или Главная)
                }
                is AuthEvent.Error -> {
                    Toast.makeText(context, event.message, Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    // Состояния ошибок
    var isPasswordError by remember { mutableStateOf(false) }
    var passwordErrorText by remember { mutableStateOf<String?>(null) }

    // Функция проверки надежности
    fun validatePassword(): Boolean {
        if (password != confirmPassword) {
            isPasswordError = true
            passwordErrorText = "Пароли не совпадают"
            return false
        }

        if (password.length < 8) {
            isPasswordError = true
            passwordErrorText = "Пароль должен быть не менее 8 символов"
            return false
        }

        val passwordRegex = Regex("^(?=.*[0-9])(?=.*[a-z])(?=.*[A-Z])(?=.*[@#\$%^&+=!])(?=\\S+\$).{8,}\$")

        if (!password.matches(passwordRegex)) {
            isPasswordError = true
            passwordErrorText = "Пароль должен содержать A-Z, a-z, 0-9 и символы @#$%^&+=!"
            return false
        }

        isPasswordError = false
        passwordErrorText = null
        return true
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .padding(horizontal = 20.dp)
    ) {
        // Заголовок
        Spacer(modifier = Modifier.height(103.dp))

        Row(verticalAlignment = androidx.compose.ui.Alignment.CenterVertically) {
            androidx.compose.foundation.Image(
                painter = painterResource(id = UiKitR.drawable.im_hand),
                contentDescription = null,
                modifier = Modifier.size(32.dp).padding(end = 8.dp)
            )
            Text("Создание пароля", style = Title1, color = MatuleBlack)
        }

        Spacer(modifier = Modifier.height(23.dp))

        Text(
            text = "Введите новый пароль",
            style = BodyText,
            color = MatuleBlack
        )

        Spacer(modifier = Modifier.height(35.dp))

        // Поля ввода

        // Новый пароль
        Text("Новый Пароль", style = Caption, color = MatuleBlack)
        Spacer(modifier = Modifier.height(4.dp))
        MatuleTextField(
            value = password,
            onValueChange = {
                password = it
                isPasswordError = false // Сброс ошибки при вводе
            },
            placeholder = "********",
            isPassword = true,
            isError = isPasswordError,
            errorMessage = passwordErrorText
        )

        Spacer(modifier = Modifier.height(24.dp))

        // Повторите пароль
        Text("Повторите пароль", style = Caption, color = MatuleBlack)
        Spacer(modifier = Modifier.height(4.dp))
        MatuleTextField(
            value = confirmPassword,
            onValueChange = {
                confirmPassword = it
                isPasswordError = false
            },
            placeholder = "********",
            isPassword = true,
            isError = isPasswordError
        )

        Spacer(modifier = Modifier.height(40.dp))

        // Кнопка "Сохранить"
        MatuleButton(
            text = "Сохранить",
            onClick = {
                if (validatePassword()) {
                    viewModel.finalizeRegistration(password)
                }
            },
            enabled = password.isNotEmpty() && confirmPassword.isNotEmpty()
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\CreatePasswordViewModel.kt ===

package com.aiden3630.presentation.auth

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.data.manager.TokenManager
import com.aiden3630.domain.repository.AuthRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.channels.Channel
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.flow.receiveAsFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class CreatePasswordViewModel @Inject constructor(
    private val repository: AuthRepository,
    private val tokenManager: TokenManager
) : ViewModel() {

    // Канал для отправки событий экрану (Успех/Ошибка)
    private val _event = Channel<AuthEvent>()
    val event = _event.receiveAsFlow()

    fun finalizeRegistration(password: String) {
        viewModelScope.launch {
            try {
                // Достаем данные, которые пользователь ввел на прошлом экране
                val email = tokenManager.getEmail().first()
                val name = tokenManager.getName().first()
                val surname = tokenManager.getSurname().first()

                // Вызываем регистрацию в нашем JSON-файле
                repository.signUp(
                    email = email,
                    password = password,
                    name = name,
                    surname = surname
                )

                // Если всё ок — шлем сигнал успеха
                _event.send(AuthEvent.Success)

            } catch (e: Exception) {
                // Если ошибка (например, email уже занят) — шлем текст ошибки
                _event.send(AuthEvent.Error(e.message ?: "Ошибка при сохранении"))
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\CreatePinScreen.kt ===

package com.aiden3630.presentation.auth

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleTextGray
import com.aiden3630.presentation.theme.MatuleWhite
import kotlinx.coroutines.launch

@Composable
fun CreatePinScreen(
    onPinCreated: () -> Unit = {},  tokenManager: com.aiden3630.data.manager.TokenManager = hiltViewModel()
) {
    val scope = rememberCoroutineScope()
    // Состояние введенного пин-кода (строка)
    var pinCode by remember { mutableStateOf("") }

    LaunchedEffect(pinCode) {
        if (pinCode.length == 4) {
            tokenManager.savePin(pinCode)
            onPinCreated()
        }
    }

    // Функция обработки нажатий
    @Composable
    fun onNumberClick(number: String) {
        if (pinCode.length < 4) {
            pinCode += number
        }
    }

    fun onDeleteClick() {
        if (pinCode.isNotEmpty()) {
            pinCode = pinCode.dropLast(1)
        }
    }

        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MatuleWhite)
                .padding(horizontal = 20.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Заголовки
            Spacer(modifier = Modifier.height(103.dp))

            Text(
                text = "Создайте пароль",
                style = Title1,
                color = MatuleBlack
            )

            Spacer(modifier = Modifier.height(8.dp))

            Text(
                text = "Для защиты ваших персональных данных",
                style = BodyText,
                color = MatuleTextGray,
                textAlign = TextAlign.Center
            )

            Spacer(modifier = Modifier.height(50.dp))

            // Индикатор (точки)
            PinIndicator(codeLength = pinCode.length)

            Spacer(modifier = Modifier.weight(1f)) // Толкаем клавиатуру вниз

            // Клавиатура
            NumberKeyboard(
                onNumberClick = { onNumberClick(it) },
                onDeleteClick = { onDeleteClick() }
            )

            Spacer(modifier = Modifier.height(50.dp))
        }
    }





// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\PinComponents.kt ===

package com.aiden3630.presentation.auth

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR

@Composable
fun PinIndicator(codeLength: Int) {
    Row(
        horizontalArrangement = Arrangement.spacedBy(12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        repeat(4) { index ->
            val isFilled = index < codeLength
            Box(
                modifier = Modifier
                    .size(16.dp)
                    .background(
                        color = if (isFilled) MatuleBlue else MatuleWhite,
                        shape = CircleShape
                    )
                    .then(
                        if (!isFilled) Modifier.border(1.dp, MatuleBlue, CircleShape) else Modifier
                    )
            )
        }
    }
}

@Composable
fun NumberKeyboard(
    onNumberClick: (String) -> Unit,
    onDeleteClick: () -> Unit
) {
    val keys = listOf(
        listOf("1", "2", "3"),
        listOf("4", "5", "6"),
        listOf("7", "8", "9"),
        listOf(null, "0", "del")
    )

    Column(
        verticalArrangement = Arrangement.spacedBy(24.dp),
        modifier = Modifier.fillMaxWidth()
    ) {
        keys.forEach { row ->
            Row(
                horizontalArrangement = Arrangement.SpaceEvenly,
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically
            ) {
                row.forEach { key ->
                    when (key) {
                        null -> {
                            // Пустое место для выравнивания
                            Spacer(modifier = Modifier.size(80.dp))
                        }
                        "del" -> {
                            // Кнопка удаления
                            Box(
                                modifier = Modifier
                                    .size(80.dp)
                                    .clip(CircleShape)
                                    .clickable { onDeleteClick() },
                                contentAlignment = Alignment.Center
                            ) {
                                // UI
                                Icon(
                                    painter = painterResource(id = UiKitR.drawable.ic_delete),
                                    contentDescription = "Delete",
                                    tint = MatuleBlack,
                                    modifier = Modifier.size(32.dp)
                                )
                            }
                        }
                        else -> {
                            // Кнопка с цифрой
                            Box(
                                modifier = Modifier
                                    .size(80.dp)
                                    .clip(CircleShape)
                                    .background(MatuleInputBg)
                                    .clickable { onNumberClick(key) }, // ТУТ ТОЛЬКО ЛОГИКА
                                contentAlignment = Alignment.Center
                            ) {

                                Text(
                                    text = key,
                                    style = Title1,
                                    color = MatuleBlack
                                )
                            }
                        }
                    }
                }
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\SignInPinScreen.kt ===

package com.aiden3630.presentation.auth

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleError
import com.aiden3630.presentation.theme.MatuleWhite

@Composable
fun SignInPinScreen(
    onAuthSuccess: () -> Unit = {},
    tokenManager: com.aiden3630.data.manager.TokenManager = hiltViewModel()
) {
    val savedPin by tokenManager.getPin().collectAsState(initial = null)
    var pinCode by remember { mutableStateOf("") }
    var isError by remember { mutableStateOf(false) }

    fun onNumberClick(number: String) {
        if (pinCode.length < 4) {
            isError = false // Сбрасываем ошибку при вводе
            pinCode += number

            if (pinCode.length == 4) {
                // Проверка пароля
                if (pinCode == savedPin) {
                    onAuthSuccess()
                } else {
                    // Ошибка
                    isError = true
                    pinCode = "" // Очищаем поле
                }
            }
        }
    }

    fun onDeleteClick() {
        if (pinCode.isNotEmpty()) {
            pinCode = pinCode.dropLast(1)
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .padding(horizontal = 20.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(103.dp))

        Text(
            text = "Вход", // Заголовок по макету
            style = Title1,
            color = MatuleBlack
        )

        // Показываем текст ошибки, если пароль неверный
        if (isError) {
            Spacer(modifier = Modifier.height(8.dp))
            Text(
                text = "Неверный пароль",
                style = BodyText,
                color = MatuleError,
                textAlign = TextAlign.Center
            )
        }

        Spacer(modifier = Modifier.height(50.dp))

        PinIndicator(codeLength = pinCode.length)

        Spacer(modifier = Modifier.weight(1f))

        NumberKeyboard(
            onNumberClick = { onNumberClick(it) },
            onDeleteClick = { onDeleteClick() }
        )

        Spacer(modifier = Modifier.height(50.dp))
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\SignInScreen.kt ===

package com.aiden3630.presentation.auth

import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.tooling.preview.Preview
import androidx.compose.ui.unit.dp
import android.widget.Toast
import androidx.compose.ui.platform.LocalContext
import androidx.hilt.navigation.compose.hiltViewModel

import com.aiden3630.presentation.components.MatuleButton
import com.aiden3630.presentation.components.MatuleSocialButton
import com.aiden3630.presentation.components.MatuleTextField
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleWhite
import com.aiden3630.presentation.R as UiKitR

@Composable
fun SignInScreen(
    onSignInClick: () -> Unit = {}, // Навигация
    onSignUpClick: () -> Unit = {},
    viewModel: SignInViewModel = hiltViewModel()
) {
    val context = LocalContext.current

    // collectAsState превращает поток данных (Flow) в состояние Compose
    val email by viewModel.emailState.collectAsState()
    val password by viewModel.passwordState.collectAsState()

    // Состояние ошибки валидации
    var isEmailError by remember { mutableStateOf(false) }

    fun validateEmail(mail: String): Boolean {
        val emailRegex = "^[a-z0-9_]+@[a-z0-9_]+\\.ru$".toRegex()
        return mail.matches(emailRegex)
    }

    // Слушаем события (Успех/Ошибка)
    LaunchedEffect(key1 = true) {
        viewModel.authEvent.collect { event ->
            when (event) {
                is AuthEvent.Success -> {
                    Toast.makeText(context, "Успешный вход!", Toast.LENGTH_SHORT).show()
                    onSignInClick() // Переходим дальше
                }
                is AuthEvent.Error -> {
                    Toast.makeText(context, "Ошибка: ${event.message}", Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .padding(horizontal = 20.dp)
    ) {
        // Заголовок
        Spacer(modifier = Modifier.height(103.dp))

        Column(modifier = Modifier.fillMaxWidth()) {
            Row(
                verticalAlignment = Alignment.CenterVertically,
                modifier = Modifier.fillMaxWidth()
            ) {
                Image(
                    painter = painterResource(id = UiKitR.drawable.im_hand),
                    contentDescription = "Hello Hand",
                    modifier = Modifier
                        .size(32.dp)
                        .padding(end = 8.dp)
                )

                Text(
                    text = "Добро пожаловать!",
                    style = Title1,
                    color = MatuleBlack
                )
            }

            Spacer(modifier = Modifier.height(23.dp))

            Text(
                text = "Войдите, чтобы пользоваться функциями приложения",
                style = BodyText,
                color = MatuleBlack
            )
        }

        // Поля ввода
        Spacer(modifier = Modifier.height(35.dp))

        // Email
        Text("Вход по E-mail", style = Caption, color = MatuleBlack)
        Spacer(modifier = Modifier.height(4.dp))

        MatuleTextField(
            value = email, // Значение из ViewModel
            onValueChange = {
                // Передаем изменения во ViewModel
                viewModel.onEmailChange(it)
                isEmailError = false
            },
            placeholder = "example@mail.com",
            isError = isEmailError,
            errorMessage = if (isEmailError) "Неверный формат E-mail" else null
        )

        Spacer(modifier = Modifier.height(24.dp))

        Text("Пароль", style = Caption, color = MatuleBlack)
        Spacer(modifier = Modifier.height(4.dp))
        MatuleTextField(
            value = password, // Значение из ViewModel
            onValueChange = {
                viewModel.onPasswordChange(it) // Передаем изменения
            },
            placeholder = "••••••••",
            isPassword = true
        )

        Spacer(modifier = Modifier.height(30.dp))

        // --- КНОПКА С ПРОВЕРКОЙ ---
        MatuleButton(
            text = "Далее",
            onClick = {
                if (validateEmail(email)) {
                    // Вызываем метод входа без аргументов (VM сама возьмет их из state)
                    viewModel.onSignInClick()
                } else {
                    isEmailError = true
                }
            },
            // Кнопка активна, если поля не пустые
            enabled = email.isNotEmpty() && password.isNotEmpty()
        )

        // Кнопка "Зарегистрироваться"
        Spacer(modifier = Modifier.height(16.dp))
        Box(
            modifier = Modifier.fillMaxWidth(),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = "Зарегистрироваться",
                style = BodyText.copy(color = MatuleBlue),
                modifier = Modifier.clickable { onSignUpClick() }
            )
        }
        Spacer(modifier = Modifier.height(30.dp))

        // Соцсети
        Text(
            text = "Или войдите с помощью",
            style = Caption,
            modifier = Modifier.fillMaxWidth(),
            textAlign = TextAlign.Center
        )

        Spacer(modifier = Modifier.height(20.dp))

        MatuleSocialButton(
            text = "Войти с VK",
            iconRes = UiKitR.drawable.ic_vk,
            onClick = { viewModel.onSocialLogin() }
        )

        Spacer(modifier = Modifier.height(12.dp))

        MatuleSocialButton(
            text = "Войти с Yandex",
            iconRes = UiKitR.drawable.im_yandex,
            onClick = { viewModel.onSocialLogin() }
        )

        Spacer(modifier = Modifier.height(20.dp))
    }
}

@Preview(showBackground = true)
@Composable
fun SignInScreenPreview() {
    SignInScreen()
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\SignInViewModel.kt ===

package com.aiden3630.presentation.auth

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.data.manager.TokenManager
import com.aiden3630.domain.repository.AuthRepository

import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.channels.Channel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.receiveAsFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class SignInViewModel @Inject constructor(
    private val repository: AuthRepository,
    private val tokenManager: TokenManager,
    private val notificationService: com.aiden3630.presentation.utils.NotificationService// 👈 Добавляем TokenManager
) : ViewModel() {

    private val _authEvent = Channel<AuthEvent>()
    val authEvent = _authEvent.receiveAsFlow()

    // Состояния для полей
    private val _emailState = MutableStateFlow("")
    val emailState = _emailState.asStateFlow()

    private val _passwordState = MutableStateFlow("")
    val passwordState = _passwordState.asStateFlow()

    init {
        // При запуске загружаем сохраненные данные
        viewModelScope.launch {
            tokenManager.getEmail().collect { savedEmail ->
                _emailState.value = savedEmail
            }
        }
        viewModelScope.launch {
            tokenManager.getPassword().collect { savedPass ->
                _passwordState.value = savedPass
            }
        }
    }

    // Методы для обновления текста из UI
    fun onEmailChange(newValue: String) {
        _emailState.value = newValue
    }

    fun onPasswordChange(newValue: String) {
        _passwordState.value = newValue
    }

    fun onSignInClick() {
        // Берем текущие значения
        val email = _emailState.value
        val password = _passwordState.value

        viewModelScope.launch {
            try {
                // Сохраняем введенные данные перед входом
                tokenManager.saveUserData(email, password)

                // Пробуем войти
                repository.signIn(email, password)
                notificationService.showNotification("Вход выполнен", "Добро пожаловать в Matule!")
                _authEvent.send(AuthEvent.Success)
            } catch (e: Exception) {
                _authEvent.send(AuthEvent.Error(e.message ?: "Ошибка"))
            }
        }
    }
    fun onSocialLogin() {
        viewModelScope.launch {
            // Имитируем задержку сети
            kotlinx.coroutines.delay(500)
            // Говорим "Успех"
            _authEvent.send(AuthEvent.Success)
            notificationService.showNotification("Вход выполнен", "Добро пожаловать в Matule!")
        }
    }
}

sealed class AuthEvent {
    object Success : AuthEvent()
    data class Error(val message: String) : AuthEvent()
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\SignUpScreen.kt ===

package com.aiden3630.presentation.auth

import android.widget.Toast
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.DropdownMenu
import androidx.compose.material3.DropdownMenuItem
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.components.MatuleButton
import com.aiden3630.presentation.components.MatuleTextField
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleTextGray
import com.aiden3630.presentation.theme.MatuleWhite
import com.aiden3630.presentation.components.MatuleDatePicker
import com.aiden3630.presentation.utils.convertMillisToDate

@Composable
fun SignUpScreen(
    onNextClick: () -> Unit = {},
    onBackClick: () -> Unit = {},
    viewModel: SignUpViewModel = hiltViewModel()
) {
    val context = LocalContext.current
    val scope = rememberCoroutineScope()
    // Состояния всех полей
    var name by remember { mutableStateOf("") }
    var surname by remember { mutableStateOf("") }
    var patronymic by remember { mutableStateOf("") }
    var birthDate by remember { mutableStateOf("") }
    var email by remember { mutableStateOf("") }
    var gender by remember { mutableStateOf("") }
    var isEmailError by remember { mutableStateOf(false) }
    fun validateEmail(mail: String): Boolean {
        val emailRegex = "^[a-z0-9_]+@[a-z0-9_]+\\.ru$".toRegex()
        return mail.matches(emailRegex)
    }
    var showDatePicker by remember { mutableStateOf(false) }

    LaunchedEffect(key1 = true) {
        viewModel.signUpEvent.collect { event ->
            when(event) {
                is AuthEvent.Success -> {
                    Toast.makeText(context, "Аккаунт создан!", Toast.LENGTH_SHORT).show()
                    onNextClick() // Идем создавать пароль
                }
                is AuthEvent.Error -> {
                    Toast.makeText(context, event.message, Toast.LENGTH_LONG).show()
                }
            }
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .verticalScroll(rememberScrollState())
            .padding(horizontal = 20.dp)
            .padding(bottom = 40.dp)
    ) {

        // Заголовок
        Spacer(modifier = Modifier.height(76.dp)) // Отступ сверху по макету
        Text(
            text = "Создание Профиля",
            style = Title1.copy(fontWeight = FontWeight.Bold),
            color = MatuleBlack
        )

        Spacer(modifier = Modifier.height(8.dp))

        // Описание (серый текст)
        Text(
            text = "Без профиля вы не сможете создавать проекты.",
            style = Caption,
            color = MatuleTextGray
        )
        Text(
            text = "В профиле будут храниться результаты проектов и ваши описания.",
            style = Caption,
            color = MatuleTextGray
        )

        Spacer(modifier = Modifier.height(30.dp))

        // Поля ввода

        // Имя
        MatuleTextField(
            value = name,
            onValueChange = { name = it },
            placeholder = "Имя"
        )
        Spacer(modifier = Modifier.height(16.dp))

        // Отчество
        MatuleTextField(
            value = patronymic,
            onValueChange = { patronymic = it },
            placeholder = "Отчество"
        )
        Spacer(modifier = Modifier.height(16.dp))

        // Фамилия
        MatuleTextField(
            value = surname,
            onValueChange = { surname = it },
            placeholder = "Фамилия"
        )
        Spacer(modifier = Modifier.height(16.dp))

        // Дата рождения
        MatuleTextField(
            value = birthDate,
            onValueChange = {}, // Не даем писать руками
            placeholder = "Дата рождения",
            readOnly = true, // Клавиатура не нужна
            onClick = { showDatePicker = true }, // Открываем календарь
        )
        Spacer(modifier = Modifier.height(16.dp))

        var isGenderMenuExpanded by remember { mutableStateOf(false) }

        Box(modifier = Modifier.fillMaxWidth()) {
            MatuleTextField(
                value = gender,
                onValueChange = {}, // Пусто, так как мы не даем писать руками
                placeholder = "Пол",
                readOnly = true, // Клавиатура не откроется
                onClick = { isGenderMenuExpanded = true }, // При клике открываем меню
                trailingIcon = {
                    Icon(
                        painter = painterResource(id = UiKitR.drawable.ic_chevron_down),
                        contentDescription = null,
                        tint = MatuleTextGray
                    )
                }
            )

            // Само меню
            DropdownMenu(
                expanded = isGenderMenuExpanded,
                onDismissRequest = { isGenderMenuExpanded = false },
                modifier = Modifier
                    .background(MatuleWhite)
                    .fillMaxWidth(0.9f)
            ) {
                DropdownMenuItem(
                    text = { Text("Мужской", style = BodyText) },
                    onClick = {
                        gender = "Мужской"
                        isGenderMenuExpanded = false
                    }
                )
                DropdownMenuItem(
                    text = { Text("Женский", style = BodyText) },
                    onClick = {
                        gender = "Женский"
                        isGenderMenuExpanded = false
                    }
                )
            }
        }
        Spacer(modifier = Modifier.height(16.dp))

        // Почта
        MatuleTextField(
            value = email,
            onValueChange = {
                email = it
                isEmailError = false // Сбрасываем ошибку при вводе
            },
            placeholder = "Почта",
            isError = isEmailError, // Красная рамка
            errorMessage = if (isEmailError) "Используйте a-z, 0-9 и домен .ru" else null
        )

        Spacer(modifier = Modifier.height(40.dp))

        // Кнопка Далее
        MatuleButton(
            text = "Далее",
            onClick = {
                if (validateEmail(email)) {
                    viewModel.saveTmpUserInfo(email, name, surname)
                    onNextClick()
                } else {
                    isEmailError = true
                }
            },
            enabled = name.isNotEmpty() && surname.isNotEmpty() && email.isNotEmpty()
        )
        if (showDatePicker) {
            MatuleDatePicker(
                onDateSelected = { millis ->
                    if (millis != null) {
                        birthDate = convertMillisToDate(millis)
                    }
                },
                onDismiss = { showDatePicker = false }
            )
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\auth\SignUpViewModel.kt ===

package com.aiden3630.presentation.auth

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.repository.AuthRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.channels.Channel
import kotlinx.coroutines.flow.receiveAsFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class SignUpViewModel @Inject constructor(
    private val repository: AuthRepository,
    private val tokenManager: com.aiden3630.data.manager.TokenManager,
    private val notificationService: com.aiden3630.presentation.utils.NotificationService
) : ViewModel() {

    private val _signUpEvent = Channel<AuthEvent>()
    val signUpEvent = _signUpEvent.receiveAsFlow()

    fun onSignUpClick(name: String, surname: String, email: String, pass: String) {
        viewModelScope.launch {
            try {
                repository.signUp(email, pass, name, surname)
                notificationService.showNotification("Регистрация", "Вы успешно зарегистрировались!")
                _signUpEvent.send(AuthEvent.Success)
            } catch (e: Exception) {
                _signUpEvent.send(AuthEvent.Error(e.message ?: "Ошибка регистрации"))
            }
        }
    }
    fun saveTmpUserInfo(email: String, name: String, surname: String) {
        viewModelScope.launch {
            tokenManager.saveUserInfo(email, name, surname)
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\CartItem.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleError
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatuleWhite
import com.aiden3630.presentation.R as UiKitR

@Composable
fun CartItem(
    title: String,
    price: String,
    count: Int,
    onPlusClick: () -> Unit,
    onMinusClick: () -> Unit,
    onDeleteClick: () -> Unit
) {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(138.dp) // Высота по макету
            .shadow(4.dp, RoundedCornerShape(12.dp), spotColor = Color(0xFFE4E8F5))
            .background(MatuleWhite, RoundedCornerShape(12.dp))
            .padding(16.dp)
    ) {
        Column(modifier = Modifier.fillMaxSize()) {
            Row(modifier = Modifier.fillMaxWidth()) {
                // Название товара
                Text(
                    text = title,
                    style = Headline.copy(fontWeight = FontWeight.Medium),
                    modifier = Modifier.weight(1f),
                    maxLines = 2
                )

                // Иконка удаления
                Icon(
                    painter = painterResource(id = UiKitR.drawable.ic_delete),
                    contentDescription = "Delete",
                    tint = MatuleError,
                    modifier = Modifier
                        .size(20.dp)
                        .clickable { onDeleteClick() }
                )
            }

            Spacer(modifier = Modifier.weight(1f))

            // Цена и Счетчик
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically
            ) {
                Text(
                    text = price,
                    style = Title3.copy(fontWeight = FontWeight.SemiBold),
                    color = MatuleBlack
                )

                Spacer(modifier = Modifier.weight(1f))

                // Счетчик
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    modifier = Modifier
                        .background(MatuleInputBg, RoundedCornerShape(8.dp))
                        .padding(horizontal = 8.dp, vertical = 4.dp)
                ) {
                    Icon(
                        painter = painterResource(id = UiKitR.drawable.ic_minus),
                        contentDescription = "Minus",
                        modifier = Modifier.size(20.dp).clickable { onMinusClick() },
                        tint = MatuleBlack
                    )

                    Spacer(modifier = Modifier.width(12.dp))
                    Text(text = "$count шт", style = BodyText)
                    Spacer(modifier = Modifier.width(12.dp))

                    Icon(
                        painter = painterResource(id = UiKitR.drawable.ic_plus),
                        contentDescription = "Plus",
                        modifier = Modifier.size(20.dp).clickable { onPlusClick() },
                        tint = MatuleBlack
                    )
                }
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleBottomBar.kt ===

package com.aiden3630.presentation.components

import androidx.annotation.DrawableRes
import androidx.compose.foundation.layout.size
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleGrayIcon
import com.aiden3630.presentation.theme.MatuleWhite

// Модель данных для одной вкладки
data class BottomTab(
    val route: String,
    val title: String,
    @DrawableRes val icon: Int
)

@Composable
fun MatuleBottomBar(
    currentRoute: String?,
    onNavigate: (String) -> Unit,
    tabs: List<BottomTab>
) {
    NavigationBar(
        containerColor = MatuleWhite,
        contentColor = MatuleBlue,
        tonalElevation = 8.dp
    ) {
        tabs.forEach { tab ->
            val selected = currentRoute == tab.route

            NavigationBarItem(
                selected = selected,
                onClick = { onNavigate(tab.route) },
                icon = {
                    Icon(
                        painter = painterResource(id = tab.icon),
                        contentDescription = tab.title,
                        modifier = Modifier.size(24.dp)
                    )
                },
                label = {
                    Text(
                        text = tab.title,
                        style = Caption2.copy(fontSize = 10.sp) // Маленький текст
                    )
                },
                colors = NavigationBarItemDefaults.colors(
                    selectedIconColor = MatuleBlue,
                    selectedTextColor = MatuleBlue,
                    indicatorColor = MatuleWhite,
                    unselectedIconColor = MatuleGrayIcon,
                    unselectedTextColor = MatuleGrayIcon
                )
            )
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleButton.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleBlueDisable
import com.aiden3630.presentation.theme.MatuleWhite

@Composable
fun MatuleButton(
    text: String,
    onClick: () -> Unit,
    modifier: Modifier = Modifier,
    enabled: Boolean = true
) {
    Button(
        onClick = onClick,
        enabled = enabled,
        modifier = modifier
            .fillMaxWidth() // Кнопка на всю ширину
            .height(56.dp), // Высота по макету
        shape = RoundedCornerShape(14.dp), // Закругление
        colors = ButtonDefaults.buttonColors(
            containerColor = MatuleBlue,         // Синий фон
            contentColor = MatuleWhite,          // Белый текст
            disabledContainerColor = MatuleBlueDisable, // Бледно-синий
            disabledContentColor = MatuleWhite
        )
    ) {
        Text(
            text = text,
            style = ButtonText // Стиль текста кнопки
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleChip.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatuleWhite

@Composable
fun MatuleChip(
    text: String,
    isSelected: Boolean,
    onClick: () -> Unit
) {
    Box(
        modifier = Modifier
            .clip(RoundedCornerShape(10.dp))
            .background(if (isSelected) MatuleBlue else MatuleInputBg)
            .clickable { onClick() }
            .padding(horizontal = 20.dp, vertical = 14.dp),
        contentAlignment = Alignment.Center
    ) {
        Text(
            text = text,
            style = BodyText.copy(
                fontSize = 15.sp,
                fontWeight = FontWeight.Medium
            ),
            color = if (isSelected) MatuleWhite else MatuleBlack
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleDatePicker.kt ===

package com.aiden3630.presentation.components

import androidx.compose.material3.DatePicker
import androidx.compose.material3.DatePickerDefaults
import androidx.compose.material3.DatePickerDialog
import androidx.compose.material3.ExperimentalMaterial3Api
import androidx.compose.material3.Text
import androidx.compose.material3.TextButton
import androidx.compose.material3.rememberDatePickerState
import androidx.compose.runtime.Composable
import androidx.compose.ui.graphics.Color
import com.aiden3630.presentation.theme.MatuleBlue

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MatuleDatePicker(
    onDateSelected: (Long?) -> Unit,
    onDismiss: () -> Unit
) {
    val datePickerState = rememberDatePickerState()

    DatePickerDialog(
        onDismissRequest = onDismiss,
        confirmButton = {
            TextButton(
                onClick = {
                    onDateSelected(datePickerState.selectedDateMillis)
                    onDismiss()
                }
            ) {
                Text("ОК", color = MatuleBlue)
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text("Отмена", color = MatuleBlue)
            }
        },
        colors = DatePickerDefaults.colors(
            containerColor = Color.White
        )
    ) {
        DatePicker(
            state = datePickerState,
            colors = DatePickerDefaults.colors(
                containerColor = Color.White
            )
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleSearchField.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatulePlaceholder
import com.aiden3630.presentation.theme.MatuleTextGray
import com.aiden3630.presentation.R
@Composable
fun MatuleSearchField(
    value: String,
    onValueChange: (String) -> Unit,
    modifier: Modifier = Modifier,
    placeholder: String = "Искать описания"
) {
    Box(
        modifier = modifier
            .fillMaxWidth()
            .height(52.dp)
            .background(MatuleInputBg, RoundedCornerShape(14.dp)),
        contentAlignment = Alignment.CenterStart
    ) {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = 14.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Иконка Лупы
            Icon(
                painter = painterResource(id = R.drawable.ic_search),
                contentDescription = "Search",
                tint = MatuleTextGray,
                modifier = Modifier.size(24.dp)
            )

            Spacer(modifier = Modifier.width(12.dp))

            // Поле ввода
            BasicTextField(
                value = value,
                onValueChange = onValueChange,
                modifier = Modifier.weight(1f),
                singleLine = true,
                textStyle = BodyText.copy(color = MatuleBlack),
                cursorBrush = SolidColor(MatuleBlue),
                decorationBox = { innerTextField ->
                    if (value.isEmpty()) {
                        Text(
                            text = placeholder,
                            style = BodyText.copy(color = MatulePlaceholder)
                        )
                    }
                    innerTextField()
                }
            )
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleSocialButton.kt ===

package com.aiden3630.presentation.components

import androidx.annotation.DrawableRes
import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.Image
import androidx.compose.foundation.layout.Spacer
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.size
import androidx.compose.foundation.layout.width
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleInputStroke
import com.aiden3630.presentation.theme.MatuleWhite

@Composable
fun MatuleSocialButton(
    text: String,
    @DrawableRes iconRes: Int,
    onClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    Button(
        onClick = onClick,
        modifier = modifier
            .fillMaxWidth()
            .height(60.dp),
        shape = RoundedCornerShape(12.dp),
        colors = ButtonDefaults.buttonColors(
            containerColor = MatuleWhite,
            contentColor = MatuleBlack
        ),
        border = BorderStroke(1.dp, MatuleInputStroke)
    ) {
        Image(
            painter = painterResource(id = iconRes),
            contentDescription = null,
            modifier = Modifier.size(24.dp)
        )
        Spacer(modifier = Modifier.width(12.dp))
        Text(
            text = text,
            style = BodyText.copy(fontWeight = FontWeight.Medium), // Чуть жирнее обычного
            fontSize = 17.sp,
            color = MatuleBlack
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleTextField.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.background
import androidx.compose.foundation.border
import androidx.compose.foundation.clickable
import androidx.compose.foundation.interaction.MutableInteractionSource
import androidx.compose.foundation.interaction.collectIsPressedAsState
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.Column
import androidx.compose.foundation.layout.fillMaxWidth
import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.padding
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.BasicTextField
import androidx.compose.material3.Icon
import androidx.compose.material3.IconButton
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.focus.onFocusChanged
import androidx.compose.ui.graphics.SolidColor
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.compose.ui.text.input.VisualTransformation
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleBlueFocused
import com.aiden3630.presentation.theme.MatuleError
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatuleInputIcon
import com.aiden3630.presentation.theme.MatuleInputStroke
import com.aiden3630.presentation.theme.MatulePlaceholder
import com.aiden3630.presentation.theme.MatuleRedBg
import com.aiden3630.presentation.R

@Composable
fun MatuleTextField(
    value: String,
    onValueChange: (String) -> Unit,
    placeholder: String,
    modifier: Modifier = Modifier,
    isPassword: Boolean = false,
    isError: Boolean = false,
    errorMessage: String? = null,
    trailingIcon: @Composable (() -> Unit)? = null,
    readOnly: Boolean = false, // Если true, клавиатура не откроется
    onClick: (() -> Unit)? = null // Что делать при клике на поле
) {
    var isFocused by remember { mutableStateOf(false) }
    var isPasswordVisible by remember { mutableStateOf(false) }

    // Для отслеживания нажатия в режиме readOnly
    val interactionSource = remember { MutableInteractionSource() }
    if (readOnly && onClick != null) {
        val isPressed by interactionSource.collectIsPressedAsState()
        if (isPressed) {
            LaunchedEffect(Unit) { onClick() }
        }
    }

    Column(modifier = modifier.fillMaxWidth()) {

        Box(
            modifier = Modifier
                .fillMaxWidth()
                .height(48.dp)
                .background(
                    color = if (isError) MatuleRedBg else MatuleInputBg,
                    shape = RoundedCornerShape(14.dp)
                )
                .border(
                    width = 1.dp,
                    color = when {
                        isError -> MatuleError
                        isFocused -> MatuleBlueFocused
                        else -> MatuleInputStroke
                    },
                    shape = RoundedCornerShape(14.dp)
                )
                .clickable(enabled = readOnly && onClick != null) { onClick?.invoke() },
            contentAlignment = Alignment.CenterStart
        ) {
            BasicTextField(
                value = value,
                onValueChange = onValueChange,
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(horizontal = 14.dp)
                    .padding(end = if (isPassword || trailingIcon != null) 40.dp else 0.dp)
                    .onFocusChanged { isFocused = it.isFocused },
                singleLine = true,
                readOnly = readOnly, // Запрещает клавиатуру
                enabled = !readOnly, // Отключаем стандартное поведение ввода, если readOnly
                textStyle = BodyText.copy(color = MatuleBlack),
                cursorBrush = SolidColor(MatuleBlue),
                visualTransformation = if (isPassword && !isPasswordVisible) PasswordVisualTransformation('*') else VisualTransformation.None,
                decorationBox = { innerTextField ->
                    if (value.isEmpty()) {
                        Text(
                            text = placeholder,
                            style = BodyText.copy(color = MatulePlaceholder)
                        )
                    }
                    innerTextField()
                }
            )

            // Иконки
            Box(modifier = Modifier.align(Alignment.CenterEnd).padding(end = 12.dp)) {
                if (isPassword) {
                    IconButton(onClick = { isPasswordVisible = !isPasswordVisible }) {
                        Icon(
                            painter = painterResource(id = if (isPasswordVisible) R.drawable.ic_eye else R.drawable.ic_eye_off),
                            contentDescription = "Toggle password",
                            tint = MatuleInputIcon
                        )
                    }
                } else if (trailingIcon != null) {
                    trailingIcon()
                }
            }
        }

        if (isError && errorMessage != null) {
            Text(
                text = errorMessage,
                color = MatuleError,
                style = Caption,
                modifier = Modifier.padding(start = 14.dp, top = 4.dp)
            )
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\MatuleToggle.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.layout.height
import androidx.compose.foundation.layout.width
import androidx.compose.material3.Switch
import androidx.compose.material3.SwitchDefaults
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleInputStroke
import com.aiden3630.presentation.theme.MatuleWhite

@Composable
fun MatuleToggle(
    checked: Boolean,
    onCheckedChange: (Boolean) -> Unit
) {
    // Используем стандартный Switch, но красим его под макет
    Switch(
        checked = checked,
        onCheckedChange = onCheckedChange,
        colors = SwitchDefaults.colors(
            checkedThumbColor = MatuleWhite,
            checkedTrackColor = MatuleBlue,
            uncheckedThumbColor = MatuleWhite,
            uncheckedTrackColor = MatuleInputStroke,
            uncheckedBorderColor = Color.Transparent,
            checkedBorderColor = Color.Transparent
        ),
        modifier = Modifier
            .width(48.dp) // Размеры из CSS
            .height(28.dp)
    )
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\ProductCard.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.BorderStroke
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextOverflow
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.theme.*

@Composable
fun ProductCard(
    title: String,
    price: String,
    category: String = "Мужская одежда", // Добавил поле для категории
    isInCart: Boolean = false,
    onAddClick: () -> Unit = {},
    onRemoveClick: () -> Unit = {},
    onClick: () -> Unit = {}
) {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(136.dp) // Высота карточки
            .shadow(
                elevation = 4.dp,
                shape = RoundedCornerShape(12.dp),
                spotColor = Color(0xFFE4E8F5)
            )
            .background(MatuleWhite, RoundedCornerShape(12.dp))
            .clip(RoundedCornerShape(12.dp))
            .clickable { onClick() }
            .padding(16.dp)
    ) {
        // Верхняя часть: Название и Категория
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(bottom = 40.dp)
        ) {
            // Название товара
            Text(
                text = title,
                style = Headline.copy(
                    fontWeight = FontWeight.Medium,
                    fontSize = 16.sp
                ),
                maxLines = 2,
                overflow = TextOverflow.Ellipsis
            )

            Spacer(modifier = Modifier.height(6.dp))

            // Категория
            Text(
                text = category,
                style = Caption.copy(color = MatuleTextGray)
            )
        }

        // Цена
        Text(
            text = price,
            style = Title3.copy(fontWeight = FontWeight.SemiBold),
            color = MatuleBlack,
            modifier = Modifier.align(Alignment.BottomStart)
        )

        // Кнопка
        val buttonModifier = Modifier
            .align(Alignment.BottomEnd)
            .height(40.dp)
            .width(110.dp)

        if (isInCart) {
            Button(
                onClick = onRemoveClick,
                modifier = buttonModifier,
                shape = RoundedCornerShape(10.dp),
                colors = ButtonDefaults.buttonColors(containerColor = MatuleWhite),
                border = BorderStroke(1.dp, MatuleBlue),
                contentPadding = PaddingValues(0.dp)
            ) {
                Text(
                    text = "Убрать",
                    style = Caption.copy(fontWeight = FontWeight.SemiBold, color = MatuleBlue)
                )
            }
        } else {
            Button(
                onClick = onAddClick,
                modifier = buttonModifier,
                shape = RoundedCornerShape(10.dp),
                colors = ButtonDefaults.buttonColors(containerColor = MatuleBlue),
                contentPadding = PaddingValues(0.dp)
            ) {
                Text(
                    text = "Добавить",
                    style = Caption.copy(fontWeight = FontWeight.SemiBold, color = MatuleWhite)
                )
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\components\ProjectCard.kt ===

package com.aiden3630.presentation.components

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatuleTextGray
import com.aiden3630.presentation.theme.MatuleWhite
import coil.compose.AsyncImage

@Composable
fun ProjectCard(
    title: String,
    date: String,
    imageUri: String? = null,
    onClick: () -> Unit
) {
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .height(180.dp)
            .shadow(4.dp, RoundedCornerShape(12.dp), spotColor = Color(0xFFE4E8F5))
            .background(MatuleWhite, RoundedCornerShape(12.dp))
            .clickable { onClick() }
            .padding(16.dp)
    ) {
        Column(modifier = Modifier.fillMaxSize()) {

            Text(
                text = title,
                style = Headline.copy(fontWeight = FontWeight.SemiBold),
                color = MatuleBlack
            )

            Spacer(modifier = Modifier.height(12.dp))

            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .weight(1f)
                    .clip(RoundedCornerShape(8.dp))
                    .background(MatuleInputBg),
                contentAlignment = Alignment.Center
            ) {
                if (imageUri != null) {
                    AsyncImage(
                        model = imageUri,
                        contentDescription = null,
                        contentScale = ContentScale.Crop,
                        modifier = Modifier.fillMaxSize()
                    )
                }
            }

            Spacer(modifier = Modifier.height(12.dp))

            // Нижняя строка
            Row(
                modifier = Modifier.fillMaxWidth(),
                verticalAlignment = Alignment.CenterVertically,
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Text(
                    text = date,
                    style = Caption,
                    color = MatuleTextGray
                )

                Button(
                    onClick = onClick,
                    modifier = Modifier.height(36.dp).width(100.dp),
                    shape = RoundedCornerShape(8.dp),
                    colors = ButtonDefaults.buttonColors(containerColor = MatuleBlue),
                    contentPadding = PaddingValues(0.dp)
                ) {
                    Text(
                        text = "Открыть",
                        style = Caption.copy(color = MatuleWhite, fontWeight = FontWeight.SemiBold)
                    )
                }
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CartScreen.kt ===

package com.aiden3630.presentation.main

import android.widget.Toast
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Button
import androidx.compose.material3.ButtonDefaults
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.components.CartItem
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.theme.MatuleBackground
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleBlue
import com.aiden3630.presentation.theme.MatuleWhite
import com.aiden3630.presentation.R as UiKitR
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.main.CartViewModel

@Composable
fun CartScreen(
    onBackClick: () -> Unit = {},onGoHome: () -> Unit = {},
    viewModel: CartViewModel = hiltViewModel()
) {
    // Получаем данные из VM
    val context = LocalContext.current
    val items by viewModel.cartItems.collectAsState()
    val totalSum by viewModel.totalSum.collectAsState()

    LaunchedEffect(true) {
        viewModel.cartEvent.collect { event ->
            when (event) {
                is CartEvent.OrderSuccess -> {
                    Toast.makeText(context, "Заказ успешно оформлен!", Toast.LENGTH_LONG).show()
                    onGoHome() // Уходим на главную
                }
            }
        }
    }
    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleBackground)
            .statusBarsPadding()
            .padding(horizontal = 20.dp)
    ) {
        // Хедер
        Spacer(modifier = Modifier.height(20.dp))
        Box(modifier = Modifier.fillMaxWidth()) {
            Box(
                modifier = Modifier
                    .size(32.dp)
                    .background(MatuleWhite, RoundedCornerShape(8.dp))
                    .clickable { onBackClick() }
                    .align(Alignment.CenterStart),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    painter = painterResource(id = UiKitR.drawable.ic_chevron_left),
                    contentDescription = "Back",
                    tint = MatuleBlack
                )
            }
            Text(text = "Корзина", style = Title2, modifier = Modifier.align(Alignment.Center))

            // Иконка мусорки справа
            Icon(
                painter = painterResource(id = UiKitR.drawable.ic_delete),
                contentDescription = "Clear",
                tint = MatuleBlack,
                modifier = Modifier.align(Alignment.CenterEnd).size(24.dp) .clickable { viewModel.onClearCartClick() }
            )
        }

        Spacer(modifier = Modifier.height(30.dp))
        Text(text = "${items.size} товаров", style = BodyText)
        Spacer(modifier = Modifier.height(16.dp))

        // Список товаров
        if (items.isEmpty()) {
            Box(modifier = Modifier.weight(1f).fillMaxWidth(), contentAlignment = Alignment.Center) {
                Text("Корзина пуста", style = Title3, color = MatuleTextGray)
            }
        } else {
            LazyColumn(
                modifier = Modifier.weight(1f),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                items(items.size) { index ->
                    val cartItem = items[index]
                    CartItem(
                        title = cartItem.product.title,
                        price = "${cartItem.product.price} ₽",
                        count = cartItem.quantity,
                        onPlusClick = { viewModel.onPlusClick(cartItem.product) },
                        onMinusClick = { viewModel.onMinusClick(cartItem.product) },
                        onDeleteClick = { viewModel.onDeleteClick(cartItem.product) }
                    )
                }
            }
        }

        // Итого
        if (items.isNotEmpty()) {
            Column {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    Text("Сумма", style = Title2)
                    Text("$totalSum ₽", style = Title2)
                }
                Spacer(modifier = Modifier.height(30.dp))
                Button(
                    onClick = { viewModel.checkout() },
                    modifier = Modifier.fillMaxWidth().height(56.dp),
                    shape = RoundedCornerShape(14.dp),
                    colors = ButtonDefaults.buttonColors(containerColor = MatuleBlue)
                ) {
                    Text("Перейти к оформлению заказа", style = ButtonText)
                }
                Spacer(modifier = Modifier.height(20.dp))
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CartViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.data.manager.CartManager
import com.aiden3630.domain.model.Product
import com.aiden3630.presentation.utils.NotificationService
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.channels.Channel
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.receiveAsFlow
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import javax.inject.Inject
@HiltViewModel
class CartViewModel @Inject constructor(
    private val cartManager: CartManager,
    private val notificationService: NotificationService
) : ViewModel() {

    // Подписываемся на изменения в менеджере
    val cartItems = cartManager.cartItems
    private val _cartEvent = Channel<CartEvent>()
    val cartEvent = _cartEvent.receiveAsFlow()

    val totalSum = cartManager.totalPrice
        .stateIn(viewModelScope, SharingStarted.Lazily, 0)

    fun onPlusClick(product: Product) {
        cartManager.addToCart(product)
    }

    fun onMinusClick(product: Product) {
        cartManager.decreaseQuantity(product)
    }

    fun onDeleteClick(product: Product) {
        cartManager.removeFromCart(product)
    }

    fun onClearCartClick() {
        cartManager.clearCart()
    }
    fun checkout() {
        viewModelScope.launch {
            // Запоминаем сумму перед очисткой, чтобы показать в уведомлении
            val currentSum = totalSum.value

            // Чистим корзину
            cartManager.clearCart()

            // Уведомление
            notificationService.showNotification(
                title = "Заказ успешно оформлен!",
                message = "Сумма заказа: $currentSum ₽. Спасибо за покупку!"
            )

            // Отправляем событие для навигации
            _cartEvent.send(CartEvent.OrderSuccess)
        }
    }
}
sealed class CartEvent {
    object OrderSuccess : CartEvent()
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CatalogScreen.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.domain.model.Product
import com.aiden3630.presentation.components.MatuleChip
import com.aiden3630.presentation.components.MatuleSearchField
import com.aiden3630.presentation.components.ProductCard
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CatalogScreen(
    onCartClick: () -> Unit = {},
    onProfileClick: () -> Unit = {},
    cartViewModel: CartViewModel = hiltViewModel(),
    catalogViewModel: CatalogViewModel = hiltViewModel()
) {
    val searchText by catalogViewModel.searchText.collectAsState()
    val selectedCategory by catalogViewModel.selectedCategory.collectAsState()
    val products by catalogViewModel.filteredProducts.collectAsState()

    val cartItems by cartViewModel.cartItems.collectAsState()
    val cartTotal by cartViewModel.totalSum.collectAsState()

    var selectedProductForSheet by remember { mutableStateOf<Product?>(null) }
    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)

    val categories = listOf("Все", "Мужчинам", "Женщинам", "Детям", "Аксессуары")

    Box(modifier = Modifier.fillMaxSize()) {

        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .background(MatuleWhite)
                .padding(horizontal = 20.dp),
            contentPadding = PaddingValues(bottom = 100.dp)
        ) {
            // Хедер
            item {
                Spacer(modifier = Modifier.height(20.dp))
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    MatuleSearchField(
                        value = searchText,
                        onValueChange = { catalogViewModel.onSearchTextChange(it) },
                        modifier = Modifier.weight(1f)
                    )

                    Spacer(modifier = Modifier.width(14.dp))

                    Box(
                        modifier = Modifier
                            .size(48.dp)
                            .clickable { onProfileClick() },
                        contentAlignment = Alignment.CenterEnd
                    ) {
                        Icon(
                            painter = painterResource(id = UiKitR.drawable.ic_profile_black),
                            contentDescription = "Profile",
                            tint = MatuleBlack,
                            modifier = Modifier.size(32.dp)
                        )
                    }
                }
                Spacer(modifier = Modifier.height(24.dp))
            }

            // Категории
            item {
                LazyRow(horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                    items(categories.size) { index ->
                        MatuleChip(
                            text = categories[index],
                            isSelected = selectedCategory == categories[index],
                            onClick = {
                                catalogViewModel.onCategoryChange(categories[index])
                            }
                        )
                    }
                }
                Spacer(modifier = Modifier.height(24.dp))
            }

            // Товары
            if (products.isEmpty()) {
                item {
                    Box(modifier = Modifier.fillMaxWidth().padding(top = 20.dp), contentAlignment = Alignment.Center) {
                        Text(
                            text = "Ничего не найдено",
                            style = BodyText,
                            color = MatuleTextGray
                        )
                    }
                }
            } else {
                items(items = products) { product: Product ->

                    val isProductInCart = cartItems.any { cartItem -> cartItem.product.id == product.id }

                    ProductCard(
                        title = product.title,
                        price = "${product.price} ₽",
                        category = product.category,
                        isInCart = isProductInCart,

                        onAddClick = { cartViewModel.onPlusClick(product) },
                        onRemoveClick = { cartViewModel.onDeleteClick(product) },
                        onClick = { selectedProductForSheet = product }
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                }
            }
        }

        // Кнопка Корзины
        if (cartTotal > 0) {
            Box(
                modifier = Modifier
                    .align(Alignment.BottomCenter)
                    .padding(bottom = 20.dp, start = 20.dp, end = 20.dp)
                    .fillMaxWidth()
                    .height(56.dp)
                    .shadow(10.dp, RoundedCornerShape(12.dp), spotColor = Color(0x40000000))
                    .background(MatuleBlue, RoundedCornerShape(12.dp))
                    .clickable { onCartClick() }
            ) {
                Row(
                    modifier = Modifier.align(Alignment.CenterStart).padding(start = 16.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        painter = painterResource(id = UiKitR.drawable.ic_cart),
                        contentDescription = null,
                        tint = MatuleWhite,
                        modifier = Modifier.size(24.dp)
                    )
                    Spacer(modifier = Modifier.width(16.dp))
                    Text("В корзину", style = Title3.copy(color = MatuleWhite, fontWeight = FontWeight.SemiBold))
                }
                Text("$cartTotal ₽", style = Title3.copy(color = MatuleWhite, fontWeight = FontWeight.SemiBold), modifier = Modifier.align(Alignment.CenterEnd).padding(end = 16.dp))
            }
        }

        // Шторка
        if (selectedProductForSheet != null) {
            ModalBottomSheet(
                onDismissRequest = { selectedProductForSheet = null },
                sheetState = sheetState,
                containerColor = MatuleWhite,
                shape = RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp)
            ) {
                ProductDetailsSheet(
                    title = selectedProductForSheet!!.title,
                    price = "${selectedProductForSheet!!.price} ₽",
                    description = selectedProductForSheet!!.description,
                    onDismiss = { selectedProductForSheet = null },
                    onAddToCart = {
                        cartViewModel.onPlusClick(selectedProductForSheet!!)
                        selectedProductForSheet = null
                    }
                )
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CatalogViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.model.Product
import com.aiden3630.domain.repository.ShopRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class CatalogViewModel @Inject constructor(
    private val shopRepository: ShopRepository
) : ViewModel() {

    private val _allProducts = MutableStateFlow<List<Product>>(emptyList())

    private val _searchText = MutableStateFlow("")
    val searchText = _searchText.asStateFlow()

    private val _selectedCategory = MutableStateFlow("Все")
    val selectedCategory = _selectedCategory.asStateFlow()

    // Наш отфильтрованный список
    val filteredProducts = combine(_allProducts, _searchText, _selectedCategory) { products, text, category ->
        products.filter { product ->
            val matchesSearch = product.title.contains(text, ignoreCase = true)
            val matchesCategory = if (category == "Все") true else product.category == category
            matchesSearch && matchesCategory
        }
    }.stateIn(viewModelScope, SharingStarted.WhileSubscribed(5000), emptyList())

    init {
        loadProducts()
    }

    private fun loadProducts() {
        viewModelScope.launch {
            shopRepository.getProducts().collect { list ->
                _allProducts.value = list
            }
        }
    }

    fun onSearchTextChange(text: String) { _searchText.value = text }
    fun onCategoryChange(category: String) { _selectedCategory.value = category }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CreateProjectScreen.kt ===

package com.aiden3630.presentation.main

import android.Manifest
import android.net.Uri
import android.widget.Toast
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImage
import com.aiden3630.presentation.components.MatuleButton
import com.aiden3630.presentation.components.MatuleDatePicker
import com.aiden3630.presentation.components.MatuleTextField
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.utils.convertMillisToDate
import com.aiden3630.presentation.utils.createImageFile
import com.aiden3630.presentation.R as UiKitR

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun CreateProjectScreen(
    onBackClick: () -> Unit = {},
    viewModel: CreateProjectViewModel = hiltViewModel()
) {

    val context = LocalContext.current

    // --- Состояния полей ---
    var type by remember { mutableStateOf("") }
    var name by remember { mutableStateOf("") }
    var dateStart by remember { mutableStateOf("") }
    var dateEnd by remember { mutableStateOf("") }
    var toWhom by remember { mutableStateOf("") }
    var source by remember { mutableStateOf("") }
    var category by remember { mutableStateOf("") }

    // Для календаря
    var dateFieldType by remember { mutableStateOf<String?>(null) }

    // Состояние картинки
    var selectedImageUri by remember { mutableStateOf<Uri?>(null) }
    var tempCameraUri by remember { mutableStateOf<Uri?>(null) }

    // Состояние шторки
    var showPhotoSheet by remember { mutableStateOf(false) }
    val sheetState = rememberModalBottomSheetState(skipPartiallyExpanded = true)

    // Списки
    val typeOptions = listOf("Вязание спицами", "Вязание крючком", "Шитье", "Вышивка")
    val whoOptions = listOf("Себе", "В подарок", "На продажу", "Детям")
    val categoryOptions = listOf("Одежда", "Игрушки", "Аксессуары", "Дом")

    val galleryLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.GetContent()
    ) { uri: Uri? ->
        uri?.let { selectedImageUri = it }
    }

    val cameraLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.TakePicture()
    ) { success ->
        if (success && tempCameraUri != null) {
            selectedImageUri = tempCameraUri
        }
    }

    val permissionLauncher = rememberLauncherForActivityResult(
        contract = ActivityResultContracts.RequestPermission()
    ) { isGranted ->
        if (isGranted) {
            val uri = context.createImageFile()
            tempCameraUri = uri
            cameraLauncher.launch(uri)
        } else {
            Toast.makeText(context, "Нужен доступ к камере", Toast.LENGTH_SHORT).show()
        }
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .padding(horizontal = 20.dp)
            .verticalScroll(rememberScrollState())
    ) {
        // Хедер
        Spacer(modifier = Modifier.height(20.dp))
        Box(modifier = Modifier.fillMaxWidth()) {
            Icon(
                painter = painterResource(id = UiKitR.drawable.ic_chevron_left),
                contentDescription = "Back",
                modifier = Modifier
                    .size(24.dp)
                    .clickable { onBackClick() }
                    .align(Alignment.CenterStart)
            )
            Text(
                text = "Создать проект",
                style = Title2,
                modifier = Modifier.align(Alignment.Center)
            )
        }
        Spacer(modifier = Modifier.height(30.dp))

        // Поля
        InputLabel("Тип")
        ProjectDropdown(value = type, onValueChange = { type = it }, placeholder = "Выберите тип", options = typeOptions)
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Название проекта")
        MatuleTextField(value = name, onValueChange = { name = it }, placeholder = "Введите имя")
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Дата начала")
        MatuleTextField(
            value = dateStart,
            onValueChange = {},
            placeholder = "ДД.ММ.ГГГГ",
            readOnly = true,
            onClick = { dateFieldType = "start" }
        )
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Дата Окончания")
        MatuleTextField(
            value = dateEnd,
            onValueChange = {},
            placeholder = "ДД.ММ.ГГГГ",
            readOnly = true,
            onClick = { dateFieldType = "end" }
        )
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Кому")
        ProjectDropdown(value = toWhom, onValueChange = { toWhom = it }, placeholder = "Выберите кому", options = whoOptions)
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Источник описания")
        MatuleTextField(value = source, onValueChange = { source = it }, placeholder = "example.com")
        Spacer(modifier = Modifier.height(16.dp))

        InputLabel("Категория")
        ProjectDropdown(value = category, onValueChange = { category = it }, placeholder = "Выберите категорию", options = categoryOptions)
        Spacer(modifier = Modifier.height(24.dp))

        // Фото
        Box(
            modifier = Modifier
                .size(200.dp)
                .clip(RoundedCornerShape(12.dp))
                .background(MatuleInputBg)
                .clickable { showPhotoSheet = true }
                .align(Alignment.CenterHorizontally),
            contentAlignment = Alignment.Center
        ) {
            if (selectedImageUri != null) {
                AsyncImage(
                    model = selectedImageUri,
                    contentDescription = "Project Image",
                    contentScale = ContentScale.Crop,
                    modifier = Modifier.fillMaxSize()
                )
            } else {
                Icon(
                    painter = painterResource(id = UiKitR.drawable.ic_plus),
                    contentDescription = "Add Photo",
                    tint = MatuleTextGray,
                    modifier = Modifier.size(48.dp)
                )
            }
        }

        Spacer(modifier = Modifier.height(40.dp))

        // Кнопка Подтвердить
        MatuleButton(
            text = "Подтвердить",
            onClick = {
                viewModel.createProject(
                    context = context,
                    name = name,
                    type = type,
                    dateStart = dateStart,
                    imageUri = selectedImageUri
                ) {
                    Toast.makeText(context, "Проект создан!", Toast.LENGTH_SHORT).show()
                    onBackClick()
                }
            },
            enabled = name.isNotEmpty()
        )
        Spacer(modifier = Modifier.height(40.dp))
    }

    // Календарь
    if (dateFieldType != null) {
        MatuleDatePicker(
            onDateSelected = { millis ->
                if (millis != null) {
                    val formattedDate = convertMillisToDate(millis)
                    if (dateFieldType == "start") dateStart = formattedDate else dateEnd = formattedDate
                }
            },
            onDismiss = { dateFieldType = null }
        )
    }

    // Шторка Фото
    if (showPhotoSheet) {
        ModalBottomSheet(
            onDismissRequest = { showPhotoSheet = false },
            sheetState = sheetState,
            containerColor = MatuleWhite
        ) {
            Column(
                modifier = Modifier.fillMaxWidth().padding(20.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                Text("Загрузить фото", style = Title2)
                Spacer(modifier = Modifier.height(20.dp))
                MatuleButton(text = "Сделать фото", onClick = {
                    showPhotoSheet = false
                    permissionLauncher.launch(Manifest.permission.CAMERA)
                })
                Spacer(modifier = Modifier.height(12.dp))
                MatuleButton(text = "Выбрать из галереи", onClick = {
                    showPhotoSheet = false
                    galleryLauncher.launch("image/*")
                })
                Spacer(modifier = Modifier.height(40.dp))
            }
        }
    }
}

// Вспомогательные функции
@Composable
fun InputLabel(text: String) {
    Text(
        text = text,
        style = Caption,
        color = MatuleTextGray,
        modifier = Modifier.padding(bottom = 6.dp)
    )
}

@Composable
fun ProjectDropdown(value: String, onValueChange: (String) -> Unit, placeholder: String, options: List<String>) {
    var expanded by remember { mutableStateOf(false) }
    Box(modifier = Modifier.fillMaxWidth()) {
        MatuleTextField(
            value = value,
            onValueChange = {},
            placeholder = placeholder,
            readOnly = true,
            onClick = { expanded = true },
            trailingIcon = {
                Icon(painter = painterResource(id = UiKitR.drawable.ic_chevron_down), contentDescription = null, tint = MatuleTextGray)
            }
        )
        DropdownMenu(
            expanded = expanded,
            onDismissRequest = { expanded = false },
            modifier = Modifier.background(MatuleWhite).fillMaxWidth(0.9f)
        ) {
            options.forEach { option ->
                DropdownMenuItem(
                    text = { Text(option, style = BodyText) },
                    onClick = { onValueChange(option); expanded = false }
                )
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\CreateProjectViewModel.kt ===

package com.aiden3630.presentation.main

import android.content.Context
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.repository.ProjectRepository
import com.aiden3630.presentation.utils.saveUriToInternalStorage
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.launch
import android.net.Uri
import javax.inject.Inject

@HiltViewModel
class CreateProjectViewModel @Inject constructor(
    private val repository: ProjectRepository,
    private val notificationService: com.aiden3630.presentation.utils.NotificationService
) : ViewModel() {
    fun createProject(
        context: Context, // Передаем контекст
        name: String,
        type: String,
        dateStart: String,
        imageUri: Uri?,
        onSuccess: () -> Unit
    ) {
        viewModelScope.launch {
            val savedImagePath = if (imageUri != null) {
                saveUriToInternalStorage(context, imageUri)
            } else {
                null
            }

            repository.createProject(name, type, dateStart, savedImagePath)
            notificationService.showNotification("Новый проект", "Проект '$name' успешно создан!")

            onSuccess()
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\HomeScreen.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.draw.shadow
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.components.MatuleChip
import com.aiden3630.presentation.components.MatuleSearchField
import com.aiden3630.presentation.components.ProductCard
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR
import androidx.compose.ui.zIndex
import androidx.compose.foundation.lazy.items

@Composable
fun HomeScreen(
    onCartClick: () -> Unit = {},
    cartViewModel: CartViewModel = hiltViewModel(),
    homeViewModel: HomeViewModel = hiltViewModel()
) {
    val searchText by homeViewModel.searchText.collectAsState()
    val selectedCategory by homeViewModel.selectedCategory.collectAsState()
    val products by homeViewModel.filteredProducts.collectAsState()

    // Данные для корзины (сумма и список покупок)
    val cartItems by cartViewModel.cartItems.collectAsState()
    val cartTotal by cartViewModel.totalSum.collectAsState()

    val categories = listOf("Все", "Мужчинам", "Женщинам", "Детям")


    Box(modifier = Modifier.fillMaxSize()) {

        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .background(MatuleWhite)
                .padding(horizontal = 20.dp),
            contentPadding = PaddingValues(bottom = 100.dp)
        ) {
            // Поиск
            item {
                Spacer(modifier = Modifier.height(20.dp))
                MatuleSearchField(
                    value = searchText,
                    onValueChange = {
                        homeViewModel.onSearchTextChange(it)
                    }
                )
                Spacer(modifier = Modifier.height(24.dp))
            }

            // Баннеры
            item {
                Text(text = "Акции и новости", style = Title3)
                Spacer(modifier = Modifier.height(16.dp))

                LazyRow(horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                    item {
                        BannerItem(
                            title = "Шорты\nВторник",
                            price = "4000 ₽",
                            gradient = Brush.linearGradient(listOf(Color(0xFF97D9F0), Color(0xFF92E9D4))),
                            imageRes = UiKitR.drawable.im_banner_1
                        )
                    }
                    item {
                        BannerItem(
                            title = "Рубашка\nВоскресенье",
                            price = "8000 ₽",
                            gradient = Brush.linearGradient(listOf(Color(0xFF76B3FF), Color(0xFFCDE3FF))),
                            imageRes = UiKitR.drawable.im_banner_1
                        )
                    }
                }
                Spacer(modifier = Modifier.height(24.dp))
            }

            // Категории
            item {
                Text(text = "Каталог описаний", style = Title3)
                Spacer(modifier = Modifier.height(16.dp))
                LazyRow(horizontalArrangement = Arrangement.spacedBy(16.dp)) {
                    items(categories.size) { index ->
                        MatuleChip(
                            text = categories[index],
                            isSelected = selectedCategory == categories[index],
                            onClick = {
                                homeViewModel.onCategoryChange(categories[index])
                            }
                        )
                    }
                }
                Spacer(modifier = Modifier.height(24.dp))
            }

            // Товары
            if (products.isEmpty()) {
                // Если ничего не найдено
                item {
                    Box(modifier = Modifier.fillMaxWidth().height(100.dp), contentAlignment = Alignment.Center) {
                        Text("Ничего не найдено", style = BodyText, color = MatuleTextGray)
                    }
                }
            } else {
                items(products) { product ->

                    val isProductInCart = cartItems.any { cartItem -> cartItem.product.id == product.id }

                    ProductCard(
                        title = product.title,
                        price = "${product.price} ₽",
                        category = product.category,
                        isInCart = isProductInCart,

                        onAddClick = {
                            cartViewModel.onPlusClick(product)
                        },

                        onRemoveClick = {
                            cartViewModel.onDeleteClick(product)
                        },

                        onClick = {}
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                }
            }
        }

        // Плавающая кнопка
        if (cartTotal > 0) {
            Box(
                modifier = Modifier
                    .align(Alignment.BottomCenter)
                    .padding(bottom = 20.dp, start = 20.dp, end = 20.dp)
                    .fillMaxWidth()
                    .height(56.dp)
                    .shadow(10.dp, RoundedCornerShape(12.dp), spotColor = Color(0x40000000))
                    .background(MatuleBlue, RoundedCornerShape(12.dp))
                    .clickable { onCartClick() }
            ) {
                Row(
                    modifier = Modifier
                        .align(Alignment.CenterStart)
                        .padding(start = 16.dp),
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Icon(
                        painter = painterResource(id = UiKitR.drawable.ic_cart),
                        contentDescription = null,
                        tint = MatuleWhite,
                        modifier = Modifier.size(24.dp)
                    )
                    Spacer(modifier = Modifier.width(16.dp))
                    Text(
                        text = "В корзину",
                        style = Title3.copy(color = MatuleWhite, fontWeight = FontWeight.SemiBold)
                    )
                }

                // Сумма обновляется сама, так как cartTotal - это State
                Text(
                    text = "$cartTotal ₽",
                    style = Title3.copy(color = MatuleWhite, fontWeight = FontWeight.SemiBold),
                    modifier = Modifier
                        .align(Alignment.CenterEnd)
                        .padding(end = 16.dp)
                )
            }
        }
    }
}

// Компонент баннера
@Composable
fun BannerItem(
    title: String,
    price: String,
    gradient: Brush,
    imageRes: Int
) {
    Box(
        modifier = Modifier
            .width(270.dp)
            .height(152.dp)
            .clip(RoundedCornerShape(12.dp))
            .background(gradient)
            .clickable { }
    ) {
        // Текст
        Column(
            modifier = Modifier
                .padding(16.dp)
                .fillMaxHeight()
                .width(140.dp)
                .zIndex(2f) // Текст поверх картинки
        ) {
            Text(
                text = title,
                style = Title2.copy(color = MatuleWhite, fontSize = 20.sp),
                lineHeight = 24.sp
            )
            Spacer(modifier = Modifier.weight(1f))
            Text(
                text = price,
                style = Title2.copy(color = MatuleWhite, fontSize = 20.sp)
            )
        }

        // Картинка
        Image(
            painter = painterResource(id = imageRes),
            contentDescription = null,
            // Используем Fit, чтобы банка не была "жирной", но занимала высоту
            contentScale = androidx.compose.ui.layout.ContentScale.Fit,
            modifier = Modifier
                .align(Alignment.BottomEnd)
                .height(160.dp)
                .offset(x = 5.dp, y = 5.dp)
        )
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\HomeViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.model.Product
import com.aiden3630.domain.repository.ShopRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.combine
import kotlinx.coroutines.flow.stateIn
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class HomeViewModel @Inject constructor(
    private val shopRepository: ShopRepository
) : ViewModel() {

    // Исходные данные загружаются из Репозитория
    private val _allProducts = MutableStateFlow<List<Product>>(emptyList())

    // Состояние поиска и категории
    private val _searchText = MutableStateFlow("")
    val searchText = _searchText.asStateFlow()

    private val _selectedCategory = MutableStateFlow("Все")
    val selectedCategory = _selectedCategory.asStateFlow()

    // Умный список
    val filteredProducts = combine(_allProducts, _searchText, _selectedCategory) { products, text, category ->
        products.filter { product ->
            // Условие 1: Поиск по названию (игнорируя регистр)
            val matchesSearch = product.title.contains(text, ignoreCase = true)

            // Условие 2: Фильтр по категории (если "Все", то берем всё)
            val matchesCategory = if (category == "Все") true else product.category == category

            matchesSearch && matchesCategory
        }
    }.stateIn(
        scope = viewModelScope,
        started = SharingStarted.WhileSubscribed(5000),
        initialValue = emptyList()
    )

    init {
        loadProducts()
    }

    private fun loadProducts() {
        viewModelScope.launch {
            shopRepository.getProducts().collect { list ->
                _allProducts.value = list
            }
        }
    }

    // Методы для UI
    fun onSearchTextChange(text: String) {
        _searchText.value = text
    }

    fun onCategoryChange(category: String) {
        _selectedCategory.value = category
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\MainScreen.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.padding
import androidx.compose.material3.Scaffold
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.currentBackStackEntryAsState
import androidx.navigation.compose.rememberNavController
import com.aiden3630.presentation.Route
import com.aiden3630.presentation.components.BottomTab
import com.aiden3630.presentation.components.MatuleBottomBar
import com.aiden3630.presentation.R as UiKitR
@Composable
fun MainScreen(onNavigateToCart: () -> Unit = {}, onNavigateToCreateProject: () -> Unit = {}, onLogout: () -> Unit = {}, onNavigateToProjectDetails: (String) -> Unit = {}) {
    // У главного экрана свой собственный NavController
    val bottomNavController = rememberNavController()


    // Получаем текущий маршрут, чтобы подсветить иконку
    val navBackStackEntry by bottomNavController.currentBackStackEntryAsState()
    val currentRoute = navBackStackEntry?.destination?.route

    // Список вкладок
    val tabs = listOf(
        BottomTab(Route.HOME_TAB, "Главная", UiKitR.drawable.ic_home),
        BottomTab(Route.CATALOG_TAB, "Каталог", UiKitR.drawable.ic_catalog),
        BottomTab(Route.PROJECTS_TAB, "Проекты", UiKitR.drawable.ic_projects),
        BottomTab(Route.PROFILE_TAB, "Профиль", UiKitR.drawable.ic_profile)
    )

    Scaffold(
        bottomBar = {
            MatuleBottomBar(
                currentRoute = currentRoute,
                onNavigate = { route ->
                    bottomNavController.navigate(route) {
                        popUpTo(bottomNavController.graph.startDestinationId) { saveState = true }
                        launchSingleTop = true
                        restoreState = true
                    }
                },
                tabs = tabs
            )
        }
    ) { innerPadding ->
        // Контент вкладок
        NavHost(
            navController = bottomNavController,
            startDestination = Route.HOME_TAB,
            modifier = Modifier.padding(innerPadding)
        ) {
            // Главная
            composable(Route.HOME_TAB) {
                HomeScreen(
                    onCartClick = onNavigateToCart
                )
            }

            // Каталог (Вместо Избранного)
            composable(Route.CATALOG_TAB) {
                CatalogScreen(
                    onCartClick = onNavigateToCart,
                    onProfileClick = {
                        bottomNavController.navigate(Route.PROFILE_TAB) {
                            popUpTo(bottomNavController.graph.startDestinationId) { saveState = true }
                            launchSingleTop = true
                            restoreState = true
                        }
                    }
                )
            }
            // Проекты
            composable(Route.PROJECTS_TAB) {
                ProjectsScreen(
                    onAddProjectClick = onNavigateToCreateProject,
                    onProjectClick = { projectId ->
                        onNavigateToProjectDetails(projectId)
                    }
                )
            }

            // Профиль
            composable(Route.PROFILE_TAB) {
                ProfileScreen(
                    onLogoutClick = onLogout
                )
            }
        }
    }
}


@Composable
fun PlaceholderScreen(text: String) {
    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Text(text = text)
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProductDetailsSheet.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.components.MatuleButton
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR

@Composable
fun ProductDetailsSheet(
    title: String,
    price: String,
    description: String,
    onDismiss: () -> Unit,
    onAddToCart: () -> Unit
) {
    Column(
        modifier = Modifier
            .fillMaxWidth()
            .fillMaxHeight(0.9f)
            .background(MatuleWhite, RoundedCornerShape(topStart = 24.dp, topEnd = 24.dp))
    ) {
        // Шапка
        Box(modifier = Modifier.fillMaxWidth().padding(top = 16.dp, end = 16.dp)) {
            Icon(
                painter = painterResource(id = UiKitR.drawable.ic_close),
                contentDescription = "Close",
                tint = MatuleGrayIcon,
                modifier = Modifier.align(Alignment.CenterEnd).size(24.dp).clickable { onDismiss() }
            )
        }

        Text(
            text = title,
            style = Title1.copy(fontSize = 24.sp, fontWeight = FontWeight.Bold),
            modifier = Modifier.padding(horizontal = 20.dp)
        )

        // Контент
        Column(
            modifier = Modifier
                .weight(1f)
                .verticalScroll(rememberScrollState())
                .padding(horizontal = 20.dp, vertical = 24.dp)
        ) {
            Text(
                text = "Описание",
                style = Caption,
                color = MatuleTextGray
            )

            Spacer(modifier = Modifier.height(8.dp))

            Text(
                text = description,
                style = BodyText.copy(lineHeight = 22.sp),
                color = MatuleBlack
            )
        }
        // Кнопка
        Box(modifier = Modifier.fillMaxWidth().padding(20.dp)) {
            MatuleButton(text = "Добавить за $price", onClick = onAddToCart)
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProfileScreen.kt ===

package com.aiden3630.presentation.main

import android.content.Intent
import android.net.Uri
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.shape.CircleShape
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import com.aiden3630.presentation.components.MatuleToggle
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR
import androidx.compose.ui.draw.rotate
import androidx.compose.ui.graphics.Color
import androidx.hilt.navigation.compose.hiltViewModel
import com.aiden3630.presentation.theme.MatuleBlack
import com.aiden3630.presentation.theme.MatuleError
import com.aiden3630.presentation.theme.MatuleInputBg
import com.aiden3630.presentation.theme.MatuleTextGray
import com.aiden3630.presentation.theme.MatuleWhite
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll

@Composable
fun ProfileScreen( onLogoutClick: () -> Unit = {}, viewModel: ProfileViewModel = hiltViewModel()) {
    val context = LocalContext.current
    var isNotificationsEnabled by remember { mutableStateOf(true) }
    val state by viewModel.state.collectAsState()
    val scrollState = rememberScrollState()

    // Функция для открытия PDF (ссылки)
    fun openPdf(url: String) {
        val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
        context.startActivity(intent)
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .verticalScroll(scrollState)
            .padding(horizontal = 20.dp),
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Spacer(modifier = Modifier.height(20.dp))

        // Шапка (Имя и Почта)
        Column(
            modifier = Modifier.fillMaxWidth(),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Аватарка
            Box(
                modifier = Modifier
                    .size(80.dp)
                    .clip(CircleShape)
                    .background(MatuleInputBg),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    painter = painterResource(id = UiKitR.drawable.ic_profile_black),
                    contentDescription = null,
                    modifier = Modifier.size(40.dp),
                    tint = MatuleBlack
                )
            }
            Spacer(modifier = Modifier.height(16.dp))

            // Объединяем Имя и Фамилию
            Text(text = "${state.name} ${state.surname}", style = Title1)

            Spacer(modifier = Modifier.height(4.dp))

            // Почта
            Text(text = state.email, style = Headline, color = MatuleTextGray)
        }

        Spacer(modifier = Modifier.height(40.dp))

        // Меню

        // Мои заказы
        ProfileMenuItem(
            title = "Мои заказы",
            iconRes = UiKitR.drawable.ic_notification
        )

        Spacer(modifier = Modifier.height(16.dp))

        // Уведомления (с тогглом)
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .height(56.dp)
                .background(MatuleWhite, RoundedCornerShape(12.dp))
                .padding(horizontal = 10.dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Иконка
            Icon(
                painter = painterResource(id = UiKitR.drawable.ic_settings),
                contentDescription = null,
                tint = Color.Unspecified,
                modifier = Modifier.size(24.dp)
            )
            Spacer(modifier = Modifier.width(16.dp))

            Text(text = "Уведомления", style = Title3, modifier = Modifier.weight(1f))

            MatuleToggle(
                checked = state.isNotificationsEnabled,
                onCheckedChange = { isEnabled ->
                    viewModel.toggleNotifications(isEnabled)
                }
            )
        }

        Spacer(modifier = Modifier.weight(1f))

        // Низ
        Spacer(modifier = Modifier.height(40.dp))

        Text(
            text = "Политика конфиденциальности",
            style = Caption,
            color = MatuleTextGray,
            modifier = Modifier.clickable {
                // Ссылка на PDF
                openPdf("https://google.com")
            }
        )

        Spacer(modifier = Modifier.height(16.dp))

        Text(
            text = "Пользовательское соглашение",
            style = Caption,
            color = MatuleTextGray,
            modifier = Modifier.clickable {
                openPdf("https://google.com")
            }
        )

        Spacer(modifier = Modifier.height(30.dp))

        Text(
            text = "Выход",
            style = Title3.copy(color = MatuleError),
            modifier = Modifier.clickable {
                //Очищаем токен при выходе
                viewModel.logout()
                onLogoutClick()
            }
        )

        Spacer(modifier = Modifier.height(110.dp))
    }
}

// Вспомогательный компонент для пункта меню
@Composable
fun ProfileMenuItem(title: String, iconRes: Int) {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .height(56.dp)
            .background(MatuleWhite)
            .clickable { }
            .padding(horizontal = 10.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Icon(
            painter = painterResource(id = iconRes),
            contentDescription = null,
            tint = Color.Unspecified,
            modifier = Modifier.size(24.dp)
        )
        Spacer(modifier = Modifier.width(16.dp))
        Text(text = title, style = Title3, modifier = Modifier.weight(1f))

        // Стрелочка вправо
        Icon(
            painter = painterResource(id = UiKitR.drawable.ic_chevron_left),
            contentDescription = null,
            tint = MatuleBlack,
            modifier = Modifier.size(24.dp).rotate(180f)
        )
    }
}




// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProfileViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import javax.inject.Inject
import com.aiden3630.data.manager.TokenManager

@HiltViewModel
class ProfileViewModel @Inject constructor(
    private val tokenManager: TokenManager
) : ViewModel() {

    // Состояние UI
    private val _state = MutableStateFlow(ProfileState())
    val state = _state.asStateFlow()

    init {
        loadProfile()
    }

    private fun loadProfile() {
        viewModelScope.launch {
            // Собираем данные из DataStore
            tokenManager.getName().collect { name ->
                _state.value = _state.value.copy(name = name)
            }
        }
        viewModelScope.launch {
            tokenManager.getSurname().collect { surname ->
                _state.value = _state.value.copy(surname = surname)
            }
        }
        viewModelScope.launch {
            tokenManager.getEmail().collect { email ->
                _state.value = _state.value.copy(email = email)
            }
        }
        viewModelScope.launch {
            tokenManager.getNotificationsEnabled().collect { enabled ->
                _state.value = _state.value.copy(isNotificationsEnabled = enabled)
            }
        }
    }
    fun toggleNotifications(enabled: Boolean) {
        viewModelScope.launch {
            tokenManager.saveNotificationsEnabled(enabled)
        }
    }


    fun logout() {
        viewModelScope.launch {
            tokenManager.clearSession()
        }
    }
}

// Класс для хранения данных на экране
data class ProfileState(
    val name: String = "",
    val surname: String = "",
    val email: String = "",
    val isNotificationsEnabled: Boolean = true
)


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProjectDetailsScreen.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImage
import com.aiden3630.presentation.theme.*
import java.io.File

@Composable
fun ProjectDetailsScreen(
    projectId: String,
    onBackClick: () -> Unit,
    viewModel: ProjectDetailsViewModel = hiltViewModel()
) {
    // Загружаем проект при старте
    LaunchedEffect(projectId) {
        viewModel.loadProject(projectId)
    }

    val project by viewModel.project.collectAsState()

    if (project == null) {
        // Показываем загрузку, пока ищем проект
        Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
            CircularProgressIndicator(color = MatuleBlue)
        }
    } else {
        // Показываем данные
        Column(
            modifier = Modifier
                .fillMaxSize()
                .background(MatuleWhite)
                .verticalScroll(rememberScrollState())
                .padding(20.dp)
        ) {
            // Кнопка назад (можно добавить иконку как везде)
            TextButton(onClick = onBackClick) {
                Text("Назад", color = MatuleBlue)
            }

            Spacer(modifier = Modifier.height(10.dp))

            // Картинка
            if (project!!.imageUri != null) {
                AsyncImage(
                    model = File(project!!.imageUri!!), // Читаем из файла
                    contentDescription = null,
                    contentScale = ContentScale.Crop,
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(250.dp)
                        .clip(RoundedCornerShape(16.dp))
                )
            } else {
                Box(
                    Modifier
                        .fillMaxWidth()
                        .height(250.dp)
                        .background(MatuleInputBg, RoundedCornerShape(16.dp))
                )
            }

            Spacer(modifier = Modifier.height(24.dp))

            Text(text = project!!.name, style = Title1)
            Spacer(modifier = Modifier.height(8.dp))
            Text(text = "Категория: ${project!!.category}", style = BodyText, color = MatuleTextGray)
            Spacer(modifier = Modifier.height(8.dp))
            Text(text = "Начало: ${project!!.dateStart}", style = BodyText)
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProjectDetailsViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.model.UserProject
import com.aiden3630.domain.repository.ProjectRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class ProjectDetailsViewModel @Inject constructor(
    private val repository: ProjectRepository
) : ViewModel() {

    private val _project = MutableStateFlow<UserProject?>(null)
    val project = _project.asStateFlow()

    fun loadProject(id: String) {
        viewModelScope.launch {
            val result = repository.getProjectById(id)
            _project.value = result
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProjectsScreen.kt ===

package com.aiden3630.presentation.main

import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.Icon
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel

import com.aiden3630.domain.model.UserProject
import com.aiden3630.presentation.main.ProjectsViewModel

import com.aiden3630.presentation.components.ProjectCard
import com.aiden3630.presentation.theme.*
import com.aiden3630.presentation.R as UiKitR

@Composable
fun ProjectsScreen(
    onAddProjectClick: () -> Unit = {},
    onProjectClick: (String) -> Unit = {},
    viewModel: ProjectsViewModel = hiltViewModel()
) {
    val projects by viewModel.projects.collectAsState()

    LazyColumn(
        modifier = Modifier
            .fillMaxSize()
            .background(MatuleWhite)
            .padding(horizontal = 20.dp),
        contentPadding = PaddingValues(bottom = 100.dp)
    ) {
        // Хедер
        item {
            Spacer(modifier = Modifier.height(20.dp))
            Box(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(48.dp)
            ) {
                Text(
                    text = "Проекты",
                    style = Title2,
                    color = MatuleBlack,
                    modifier = Modifier.align(Alignment.Center)
                )

                Icon(
                    painter = painterResource(id = UiKitR.drawable.ic_plus),
                    contentDescription = "Add Project",
                    tint = MatuleBlue,
                    modifier = Modifier
                        .size(24.dp)
                        .align(Alignment.CenterEnd)
                        .clickable { onAddProjectClick() }
                )
            }
            Spacer(modifier = Modifier.height(24.dp))
        }

        // Список проектов
        if (projects.isEmpty()) {
            item {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .height(200.dp),
                    contentAlignment = Alignment.Center
                ) {
                    Text(
                        text = "У вас пока нет проектов",
                        style = BodyText,
                        color = MatuleTextGray
                    )
                }
            }
        } else {
            items(projects) { project ->
                ProjectCard(
                    title = project.name,
                    date = project.dateStart,
                    imageUri = project.imageUri,
                    onClick = {
                        onProjectClick(project.id)
                    }
                )
                Spacer(modifier = Modifier.height(16.dp))
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\main\ProjectsViewModel.kt ===

package com.aiden3630.presentation.main

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.domain.model.UserProject
import com.aiden3630.domain.repository.ProjectRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.SharingStarted
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.stateIn
import javax.inject.Inject

@HiltViewModel
class ProjectsViewModel @Inject constructor(
    repository: ProjectRepository
) : ViewModel() {

    val projects: StateFlow<List<UserProject>> = repository.getAllProjects()
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(5000),
            initialValue = emptyList()
        )
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\splash\SplashScreen.kt ===

package com.aiden3630.presentation.splash

import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.hilt.navigation.compose.hiltViewModel
import androidx.navigation.NavController
import com.aiden3630.presentation.Route
import com.aiden3630.presentation.theme.MatuleHeadingStyle
import com.aiden3630.presentation.theme.SplashBackground
import kotlinx.coroutines.delay

@Composable
fun SplashScreen(
    navController: NavController,
    viewModel: SplashViewModel = hiltViewModel() // Класс, который умеет переключать экраны
) {
    // Логика таймера
    val destination by viewModel.startDestination.collectAsState()

    LaunchedEffect(destination) {
        if (destination != null) {
            navController.navigate(destination!!) {
                // Удаляем Сплэш из истории, чтобы нельзя было вернуться назад
                popUpTo(Route.SPLASH) { inclusive = true }
            }
        }
    }

    // Внешний вид
    SplashBackground {
        Box(
            modifier = Modifier.fillMaxSize(),
            contentAlignment = Alignment.Center
        ) {
            Text(
                text = "Matule",
                style = MatuleHeadingStyle
            )
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\splash\SplashViewModel.kt ===

package com.aiden3630.presentation.splash

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.aiden3630.presentation.Route
import com.aiden3630.data.manager.TokenManager
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class SplashViewModel @Inject constructor(
    private val tokenManager: TokenManager
) : ViewModel() {

    private val _startDestination = MutableStateFlow<String?>(null)
    val startDestination = _startDestination.asStateFlow()

    init {
        checkSession()
    }

    private fun checkSession() {
        viewModelScope.launch {
            // Ждем 2 секунды
            delay(2000)

            // Читаем токен из памяти (берем первое значение)
            val token = tokenManager.getToken().first()

            // Принимаем решение
            if (!token.isNullOrEmpty()) {
                // Токен есть = Идем вводить ПИН-КОД
                _startDestination.value = Route.SIGN_IN_PIN
            } else {
                // Токена нет = Идем на ВХОД/РЕГИСТРАЦИЮ
                _startDestination.value = Route.SIGN_IN
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\theme\Color.kt ===

package com.aiden3630.presentation.theme

import androidx.compose.ui.graphics.Color

// ---  Brand Colors ---
val MatuleBlue = Color(0xFF1A6FEE)         // Accent (Основной синий)
val MatuleBlueDisable = Color(0xFFC5D2FF)  // Accent Inactive (Бледно-синий)
val MatuleSuccess = Color(0xFF00B412)      // Success (Зеленый)
val MatuleError = Color(0xFFFF4646)        // Error (Красный)

// ---  Text Colors ---
val MatuleBlack = Color(0xFF2B2B2B)        // Black (Основной текст) - оставим как было, в палитре #2D2C2C это тоже Black
val MatuleTextGray = Color(0xFF8787A1)     // Description (Серый текст)
val MatulePlaceholder = Color(0xFF98989A)  // Placeholder (Заглушка)
val MatuleWhite = Color(0xFFFFFFFF)        // White

// ---  Backgrounds & Strokes ---
val MatuleInputBg = Color(0xFFF7F7FA)      // Инпут бг (Фон поля ввода)
val MatuleInputStroke = Color(0xFFE6E6E6)  // Инпут строк (Рамка поля)
val MatuleInputIcon = Color(0xFFBFC7D1)    // Инпут иконки
val MatuleCardStroke = Color(0xFFF2F2F2) // Кард строк (Рамка карточек?)
val MatuleGrayIcon = Color(0xFFB8C1CC)
// Остальное (что не в палитре, но нужно)
val MatuleBackground = Color(0xFFF7F7F9)   // Общий фон
val MatuleBlueFocused = MatuleBlue         // Фокус (обычно равен акценту)
val MatuleRedBg = Color(0x1AFF4646)        // Фон ошибки (10% прозрачность)


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\theme\SplashBackground.kt ===

package com.aiden3630.presentation.theme

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.Composable
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.tooling.preview.Preview

@Composable
fun SplashBackground(
    modifier: Modifier = Modifier,
    content: @Composable () -> Unit = {}
) {
    // СЛОЙ 2 (Средний - вертикальный)
    val layer2Middle = Brush.verticalGradient(
        0.0f to Color(0xFF74C8E4),
        0.5052f to Color(0xFF73D5BC),
        1.0f to Color(0xFF74C8E4)
    )

    // СЛОЙ 1 (Верхний - вертикальный, с прозрачностью)
    val layer1Top = Brush.verticalGradient(
        0.0f to Color(red = 98, green = 105, blue = 240, alpha = 13),
        0.2917f to Color(red = 55, green = 64, blue = 245, alpha = 166),
        0.50f to Color(0xFF2254F5),
        0.7135f to Color(red = 55, green = 64, blue = 245, alpha = 166),
        1.0f to Color(red = 98, green = 105, blue = 240, alpha = 13)
    )

    Box(
        modifier = modifier.fillMaxSize()
    ) {
        Canvas(modifier = Modifier.fillMaxSize()) {
            val layer3Bottom = Brush.linearGradient(
                colors = listOf(
                    Color(0xFFA1CAFF),
                    Color(0xFF4D9CFF),
                    Color(0xFFA1CAFF)
                ),
                start = Offset(size.width, 0f),
                end = Offset(0f, size.height)
            )
            drawRect(brush = layer3Bottom)
        }

        Box(
            modifier = Modifier
                .fillMaxSize()
                .background(layer2Middle, alpha = 0.6f)
                .background(layer1Top)
        ) {
            content()
        }
    }
}

@Preview(showBackground = true)
@Composable
private fun SplashPreview() {
    SplashBackground()
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\theme\Type.kt ===

package com.aiden3630.presentation.theme

import androidx.compose.ui.text.TextStyle
import androidx.compose.ui.text.font.Font
import androidx.compose.ui.text.font.FontFamily
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.sp
import com.aiden3630.presentation.R


// Определение семейств шрифтов

// Специальный шрифт для заставки
val SfProDisplay = FontFamily(
    Font(R.font.sf_pro_display, FontWeight.Normal))
// Основной шрифт приложения
val Roboto = FontFamily(
    Font(R.font.roboto_regular, FontWeight.Normal),   // 400
    Font(R.font.roboto_medium, FontWeight.Medium),    // 500
    Font(R.font.roboto_bold, FontWeight.SemiBold),    // 600
    Font(R.font.roboto_bold, FontWeight.Bold),        // 700
    Font(R.font.roboto_bold, FontWeight.ExtraBold)    // 800
)

// Стиль Заставки (Спринт 3)

val MatuleHeadingStyle = TextStyle(
    fontFamily = SfProDisplay,
    fontWeight = FontWeight.Normal,
    fontSize = 40.sp,
    lineHeight = 64.sp,
    letterSpacing = 1.04.sp,
    color = MatuleWhite,
    textAlign = TextAlign.Center
)

// Стили UI Kit (Спринт 1)

// Title 1 (24px)
val Title1 = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.SemiBold, // 600
    fontSize = 24.sp,
    lineHeight = 28.sp,
    color = MatuleBlack
)

// Title 2 (20px)
val Title2 = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.SemiBold, // 600
    fontSize = 20.sp,
    lineHeight = 28.sp,
    color = MatuleBlack
)

// Title 3 (17px)
val Title3 = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.Medium,   // 500
    fontSize = 17.sp,
    lineHeight = 24.sp,
    color = MatuleBlack
)

// Headline (16px) - Заголовки разделов
val Headline = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.Medium,   // 500
    fontSize = 16.sp,
    lineHeight = 20.sp,
    color = MatuleBlack
)

// Body / Text (15px) - Основной текст
val BodyText = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.Normal,   // 400
    fontSize = 15.sp,
    lineHeight = 20.sp,
    color = MatuleBlack
)

// Caption (14px) - Подписи / Hint
val Caption = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.Normal,   // 400
    fontSize = 14.sp,
    lineHeight = 20.sp,
    color = MatuleTextGray
)

// Caption 2 (12px) - Мелкие подписи
val Caption2 = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.Normal,   // 400
    fontSize = 12.sp,
    lineHeight = 16.sp,
    color = MatuleTextGray
)

// Кнопки (Button Text) - обычно 17px или 14px Semibold
val ButtonText = TextStyle(
    fontFamily = Roboto,
    fontWeight = FontWeight.SemiBold,
    fontSize = 17.sp,
    lineHeight = 24.sp,
    color = MatuleWhite
)


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\utils\DateUtils.kt ===

package com.aiden3630.presentation.utils
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

fun convertMillisToDate(millis: Long): String {
    val formatter = SimpleDateFormat("dd.MM.yyyy", Locale.getDefault())
    return formatter.format(Date(millis))
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\utils\ImageSaver.kt ===

package com.aiden3630.presentation.utils

import android.content.Context
import android.net.Uri
import java.io.File
import java.io.FileOutputStream

fun saveUriToInternalStorage(context: Context, uri: Uri): String? {
    return try {
        // Создаем уникальное имя файла
        val fileName = "project_img_${System.currentTimeMillis()}.jpg"

        // Открываем поток чтения из временного Uri
        val inputStream = context.contentResolver.openInputStream(uri) ?: return null

        // Создаем файл во внутренней памяти
        val file = File(context.filesDir, fileName)
        val outputStream = FileOutputStream(file)

        // Копируем
        inputStream.copyTo(outputStream)

        inputStream.close()
        outputStream.close()

        // Возвращаем абсолютный путь к файлу (строку)
        file.absolutePath
    } catch (e: Exception) {
        e.printStackTrace()
        null
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\utils\NotificationService.kt ===

package com.aiden3630.presentation.utils

import android.app.NotificationChannel
import android.app.NotificationManager
import android.content.Context
import android.os.Build
import androidx.core.app.NotificationCompat
import com.aiden3630.presentation.R
import dagger.hilt.android.qualifiers.ApplicationContext
import javax.inject.Inject
import javax.inject.Singleton
import com.aiden3630.data.manager.TokenManager
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.launch

@Singleton
class NotificationService @Inject constructor(
    @ApplicationContext private val context: Context, private val tokenManager: com.aiden3630.data.manager.TokenManager
) {
    companion object {
        const val CHANNEL_ID = "matule_channel_id"
        const val CHANNEL_NAME = "Matule Notifications"
    }

    private val notificationManager =
        context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager

    init {
        createNotificationChannel()
    }

    private fun createNotificationChannel() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            val channel = NotificationChannel(
                CHANNEL_ID,
                CHANNEL_NAME,
                NotificationManager.IMPORTANCE_HIGH
            ).apply {
                description = "Уведомления о статусе заказов и аккаунта"
            }
            notificationManager.createNotificationChannel(channel)
        }
    }

    fun showNotification(title: String, message: String) {
        // Запускаем корутину, чтобы прочитать настройку из DataStore
        CoroutineScope(Dispatchers.IO).launch {
            val isEnabled = tokenManager.getNotificationsEnabled().first()

            if (isEnabled) {
                // Если разрешено = показываем
                val notification = NotificationCompat.Builder(context, CHANNEL_ID)
                    .setSmallIcon(R.drawable.ic_launcher_round)
                    .setContentTitle(title)
                    .setContentText(message)
                    .setPriority(NotificationCompat.PRIORITY_HIGH)
                    .setAutoCancel(true)
                    .build()

                val notificationManager = context.getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                notificationManager.notify(System.currentTimeMillis().toInt(), notification)
            }
        }
    }
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\utils\UriUtils.kt ===

package com.aiden3630.presentation.utils

import android.content.Context
import android.net.Uri
import androidx.core.content.FileProvider
import java.io.File
import java.text.SimpleDateFormat
import java.util.Date
import java.util.Locale

fun Context.createImageFile(): Uri {
    val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
    val imageFileName = "JPEG_" + timeStamp + "_"
    val image = File.createTempFile(
        imageFileName,
        ".jpg",
        externalCacheDir
    )
    return FileProvider.getUriForFile(
        this,
        "${packageName}.provider",
        image
    )
}


// === FILE: \presentation\src\main\java\com\aiden3630\presentation\Route.kt ===

package com.aiden3630.presentation

object Route {
    const val SPLASH = "splash"
    const val SIGN_IN = "sign_in"
    const val SIGN_UP = "sign_up"
    const val CREATE_PASSWORD = "create_password"
    const val CREATE_PIN = "create_pin"

    const val SIGN_IN_PIN = "sign_in_pin"
    const val HOME = "home"

    const val HOME_TAB = "home_tab"
    const val FAVORITE_TAB = "favorite_tab"
    const val CART = "cart_tab"
    const val PROFILE_TAB = "profile_tab"
    const val CATALOG_TAB = "catalog_tab"
    const val PROJECTS_TAB = "projects_tab"
    const val CREATE_PROJECT = "create_project"
    const val PROJECT_DETAILS = "project_details/{projectId}"
}


// === FILE: \presentation\build.gradle.kts ===


plugins {
    alias(libs.plugins.android.library)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.compose.compiler) // 👈 1. ПЛАГИН КОМПИЛЯТОРА
    alias(libs.plugins.google.devtools.ksp)
}

android {
    namespace = "com.aiden3630.presentation"
    compileSdk = 35

    defaultConfig {
        minSdk = 33
        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    // 👇 2. ВКЛЮЧЕНИЕ ФУНКЦИИ COMPOSE
    buildFeatures {
        compose = true
    }

    // 👇 ЭТО ТОЖЕ ВАЖНО (настройки Java)
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
    }
    kotlinOptions {
        jvmTarget = "11"
    }
}


dependencies {
    implementation(project(":domain"))
    implementation(project(":data"))

    // 2. Базовые Android библиотеки
    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)

    // 3. 🔥 COMPOSE (Вот этого не хватало!)
    implementation(platform(libs.androidx.compose.bom))
    implementation(libs.androidx.ui)
    implementation(libs.androidx.ui.graphics)
    implementation(libs.androidx.ui.tooling.preview)
    implementation(libs.androidx.material3) // Тут живут Text, Button, Column...

    // 4. Навигация и Hilt
    implementation(libs.androidx.navigation.compose)
    implementation(libs.hilt.android)
    implementation(libs.androidx.hilt.navigation.compose)
    ksp(libs.hilt.compiler)
    implementation("io.coil-kt:coil-compose:2.5.0")
    androidTestImplementation(libs.androidx.ui.test.junit4)
    debugImplementation(libs.androidx.ui.test.manifest)
}


// === FILE: \build.gradle.kts ===

// Top-level build file where you can add configuration options common to all sub-projects/modules.
plugins {
    alias(libs.plugins.android.application) apply false
    alias(libs.plugins.kotlin.android) apply false
    alias(libs.plugins.android.library) apply false
    alias(libs.plugins.compose.compiler) apply false
    alias(libs.plugins.jetbrains.kotlin.serialization) apply false
    alias(libs.plugins.google.devtools.ksp) apply false
    alias(libs.plugins.hilt.android) apply false
}


// === FILE: \settings.gradle.kts ===

pluginManagement {
    repositories {
        google {
            content {
                includeGroupByRegex("com\\.android.*")
                includeGroupByRegex("com\\.google.*")
                includeGroupByRegex("androidx.*")
            }
        }
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "Chempionat"
include(":app")
include(":domain")
include(":data")
include(":presentation")

